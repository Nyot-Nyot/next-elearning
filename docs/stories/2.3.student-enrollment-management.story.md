# Story 2.3: Student Enrollment Management

## Status
Draft

## Story
**As a** lecturer,
**I want to** manage student enrollments in my courses,
**so that** only authorized students can access course content

## Acceptance Criteria
1. Lecturer can view enrolled students list
2. Lecturer can add students to course (by email/ID)
3. Lecturer can remove students from course
4. Students receive enrollment notifications
5. Enrollment status is properly tracked

## Tasks / Subtasks
- [ ] Create student enrollment interface (AC: 1)
  - [ ] Build responsive student list view with search and filtering
  - [ ] Display student information (name, email, enrollment date, status)
  - [ ] Add enrollment statistics (total students, active/inactive counts)
  - [ ] Create student profile quick view with academic progress
- [ ] Implement student addition system (AC: 2)
  - [ ] Create "Add Student" form with email/ID lookup
  - [ ] Add bulk student enrollment via CSV import
  - [ ] Implement student search functionality across the platform
  - [ ] Add enrollment validation (prevent duplicate enrollments)
  - [ ] Create enrollment confirmation workflow
- [ ] Build student removal functionality (AC: 3)
  - [ ] Add individual student removal with confirmation
  - [ ] Implement bulk student removal operations
  - [ ] Create enrollment suspension (temporary removal)
  - [ ] Handle data cleanup when students are removed
  - [ ] Add enrollment history tracking
- [ ] Create notification system (AC: 4)
  - [ ] Send enrollment confirmation emails to students
  - [ ] Notify students of course updates and announcements
  - [ ] Create enrollment notification templates
  - [ ] Add notification preferences for students
  - [ ] Implement in-app notification system
- [ ] Build enrollment tracking system (AC: 5)
  - [ ] Create enrollment status management (active, suspended, completed)
  - [ ] Track enrollment history and changes
  - [ ] Add enrollment analytics and reporting
  - [ ] Implement enrollment audit logs
  - [ ] Create enrollment statistics dashboard
- [ ] Optimize enrollment operations for free tier (AC: 1, 2, 5)
  - [ ] Implement efficient enrollment queries to minimize API calls
  - [ ] Add pagination for large student lists
  - [ ] Cache enrollment data for frequently accessed courses
  - [ ] Optimize notification delivery to stay within email limits

## Dev Notes

### Previous Story Context
This story builds on completed stories:
- **Story 1.1-1.3**: Complete authentication and user management system
- **Story 2.1**: Course creation and basic setup with lecturer verification
- **Story 2.2**: Course material system (students need enrollment to access materials)
- **Dependencies**: Requires course structure, user roles, and material access control

### Technical Stack Context - Free Tier Optimized
[Source: docs/prd/technical-stack.md]
- **Frontend**: Next.js, Tailwind CSS
- **Backend**: Supabase (Free Tier - 500MB database, 2GB bandwidth)
- **Database**: PostgreSQL via Supabase for enrollment relationships
- **Email**: Supabase Auth for basic notifications (free tier limitations)
- **Hosting**: Vercel (Free Tier)

### Data Models Extension
Extended database schema for enrollment management:
```sql
-- Enrollments table (from architecture but enhanced)
CREATE TABLE enrollments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID REFERENCES users(id) ON DELETE CASCADE,
  course_id UUID REFERENCES courses(id) ON DELETE CASCADE,
  status VARCHAR(20) DEFAULT 'active', -- 'active', 'suspended', 'completed', 'dropped'
  enrolled_at TIMESTAMP DEFAULT NOW(),
  enrolled_by UUID REFERENCES users(id), -- lecturer who enrolled the student
  completed_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(student_id, course_id) -- Prevent duplicate enrollments
);

-- Enrollment history for audit trail
CREATE TABLE enrollment_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  enrollment_id UUID REFERENCES enrollments(id) ON DELETE CASCADE,
  action VARCHAR(50) NOT NULL, -- 'enrolled', 'suspended', 'reactivated', 'removed'
  performed_by UUID REFERENCES users(id),
  reason TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Enrollment notifications
CREATE TABLE enrollment_notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  enrollment_id UUID REFERENCES enrollments(id) ON DELETE CASCADE,
  type VARCHAR(50) NOT NULL, -- 'enrollment', 'removal', 'course_update'
  sent_at TIMESTAMP DEFAULT NOW(),
  delivery_status VARCHAR(20) DEFAULT 'pending' -- 'pending', 'sent', 'failed'
);
```

### File Locations
Based on Next.js conventions and enrollment management:
- Enrollment pages: `pages/courses/[id]/students/` or `app/courses/[id]/students/`
- Student management: `pages/courses/[id]/students/manage.js`
- Enrollment components: `components/enrollment/StudentList.js`, `components/enrollment/AddStudent.js`
- Enrollment utilities: `lib/enrollment.js`, `lib/notifications.js`
- Enrollment hooks: `hooks/useEnrollment.js`, `hooks/useStudentSearch.js`
- Email templates: `templates/enrollment/`

### Free Tier Database Optimization
**Enrollment Query Strategies:**
- **Batch Operations**: Minimize individual database calls
- **Efficient Joins**: Optimize user-enrollment-course queries
- **Pagination**: Limit results to reduce bandwidth usage
- **Caching**: Cache frequently accessed enrollment lists
- **Index Optimization**: Proper indexing on foreign keys

```sql
-- Optimized indexes for free tier performance
CREATE INDEX idx_enrollments_student_course ON enrollments(student_id, course_id);
CREATE INDEX idx_enrollments_course_status ON enrollments(course_id, status);
CREATE INDEX idx_enrollments_active ON enrollments(course_id) WHERE status = 'active';
```

### Email Notification Strategy (Free Tier)
**Supabase Auth Email Limitations:**
- Basic email functionality included in free tier
- Limited customization and volume
- Recommend external service for production (SendGrid free tier: 100 emails/day)

**Notification Approach:**
- **Essential Only**: Enrollment confirmations and critical updates
- **In-App Primary**: Use in-app notifications as primary method
- **Email Secondary**: Email as backup for important notifications
- **Batch Processing**: Group notifications to reduce email volume

### Student Search and Management
```javascript
// Efficient student search for free tier
const searchStudents = async (query, courseId) => {
  // Client-side filtering for small datasets
  // Server-side search for larger datasets
  // Cache results to reduce API calls
  return supabase
    .from('users')
    .select('id, name, email')
    .eq('role', 'student')
    .not('id', 'in', `(SELECT student_id FROM enrollments WHERE course_id = '${courseId}')`)
    .ilike('email', `%${query}%`)
    .limit(20); // Limit results for performance
};
```

### Technical Requirements - Free Tier Focused
- **Efficient Queries**: Minimize database API calls (500K/month limit)
- **Smart Pagination**: Load students in batches to reduce bandwidth
- **Enrollment Caching**: Cache enrollment status for frequent checks
- **Bulk Operations**: Efficient batch enrollment processing
- **Notification Throttling**: Control email frequency to avoid limits
- **Data Cleanup**: Automatic cleanup of orphaned enrollment data

### User Experience Features
- **Real-time Updates**: Enrollment changes reflected immediately
- **Bulk Management**: Multiple student operations for efficiency
- **Smart Search**: Intelligent student finding with suggestions
- **Visual Status**: Clear enrollment status indicators
- **Quick Actions**: Fast enrollment/removal operations
- **Mobile Support**: Responsive design for mobile management

### Security Considerations
- **Lecturer Authorization**: Only course lecturers can manage enrollments
- **Student Privacy**: Protect student information access
- **Enrollment Validation**: Prevent unauthorized enrollments
- **Audit Trail**: Complete history of enrollment changes
- **Data Protection**: Secure handling of student information

### Performance Optimizations
- **Lazy Loading**: Load student data on demand
- **Efficient Joins**: Optimize database relationships
- **Client Caching**: Cache enrollment data for quick access
- **Debounced Search**: Optimize search input to reduce API calls
- **Batch Processing**: Group operations for efficiency

### Enrollment Workflow
```javascript
// Optimized enrollment workflow for free tier
1. Lecturer searches for student (cached/debounced)
2. Student selection with duplicate prevention
3. Enrollment creation with optimistic updates
4. Background notification sending (queued)
5. Enrollment list refresh with updated data
6. Audit log entry for tracking
```

### Integration with Previous Stories
- **Course Access**: Links to Story 2.2 material access control
- **Role Verification**: Uses Story 1.2 role-based access system
- **User Management**: Integrates with Story 1.3 user profiles
- **Course Context**: Builds on Story 2.1 course structure

### Testing
Enrollment management requires comprehensive testing:
- **Enrollment Tests**: Add, remove, status management
- **Search Tests**: Student search and filtering functionality
- **Notification Tests**: Email and in-app notification delivery
- **Access Control Tests**: Lecturer permission verification
- **Performance Tests**: Large enrollment list handling

## Testing

### Testing Standards
Student enrollment management testing strategy:
- **Unit Tests**:
  - Enrollment validation functions (`utils/enrollmentValidation.test.js`)
  - Student search utilities (`lib/studentSearch.test.js`)
  - Notification sending logic (`lib/notifications.test.js`)
- **Component Tests**:
  - Student list rendering and interactions
  - Add/remove student functionality
  - Enrollment status management interface
- **Integration Tests**:
  - Supabase enrollment CRUD operations (`api/enrollment.test.js`)
  - Student search across platform users
  - Enrollment notification delivery
- **E2E Tests**:
  - Complete student enrollment workflow
  - Bulk enrollment operations
  - Enrollment status change scenarios
- **Access Control Tests**:
  - Lecturer-only enrollment management
  - Student privacy protection
  - Cross-course enrollment restrictions

Test file locations:
- `__tests__/enrollment/enrollmentComponents.test.js`
- `__tests__/api/enrollmentApi.test.js`
- `__tests__/e2e/enrollmentManagement.test.js`
- `__tests__/notifications/enrollmentNotifications.test.js`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-07-21 | 1.0 | Initial story creation with free tier optimization | Scrum Master (Bob) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here after implementation*
