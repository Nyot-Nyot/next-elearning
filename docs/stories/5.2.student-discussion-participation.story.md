# Story 5.2: Student Discussion Participation

## Status
Draft

## Story
**As a** student,
**I want to** participate in course discussions with rich text formatting,
**so that** I can engage meaningfully with course content and peers through well-formatted posts and replies

## Acceptance Criteria
1. Students can create new posts and reply to existing posts
2. Rich text editor supports formatting, links, and basic markup
3. Posts support threaded replies for organized conversations
4. Students can edit their own posts within a time limit
5. Post history and timestamps are maintained

## Tasks / Subtasks
- [ ] Build post creation and reply system (AC: 1)
  - [ ] Create new post composition interface
  - [ ] Implement threaded reply functionality
  - [ ] Add post preview before publishing
  - [ ] Create draft saving for long posts
  - [ ] Build post scheduling for future publication
- [ ] Implement rich text editor (AC: 2)
  - [ ] Integrate rich text editor with formatting toolbar
  - [ ] Add support for bold, italic, lists, and headers
  - [ ] Implement link insertion and validation
  - [ ] Add code snippet formatting for technical discussions
  - [ ] Create image and file attachment capabilities
- [ ] Create threaded conversation system (AC: 3)
  - [ ] Build nested reply structure with visual threading
  - [ ] Implement reply-to-specific-post functionality
  - [ ] Add conversation branching and navigation
  - [ ] Create reply notification system
  - [ ] Build conversation collapse/expand features
- [ ] Add post editing capabilities (AC: 4)
  - [ ] Implement time-limited post editing (15 minutes)
  - [ ] Add edit history tracking and display
  - [ ] Create editing conflict resolution
  - [ ] Build edit notification system
  - [ ] Add post deletion option for students
- [ ] Build post history and tracking (AC: 5)
  - [ ] Create comprehensive post timestamp system
  - [ ] Implement post edit history viewer
  - [ ] Add user activity tracking in discussions
  - [ ] Build post engagement metrics
  - [ ] Create post search within threads
- [ ] Optimize participation system for free tier (AC: 1-5)
  - [ ] Implement efficient post loading with lazy loading
  - [ ] Cache user's recent posts to reduce queries
  - [ ] Optimize rich text editor for performance
  - [ ] Create efficient threading algorithm
  - [ ] Add offline post drafting capabilities

## Dev Notes

### Previous Story Context
This story builds on the discussion foundation and enables student engagement:
- **Story 5.1**: Discussion board creation and management by lecturers
- **Epic 1 (1.1-1.3)**: User authentication and role management system
- **Epic 2 (2.1-2.3)**: Complete course creation and management system
- **Epic 3 (3.1-3.3)**: Student dashboard with progress tracking and calendar
- **Epic 4 (4.1-4.3)**: Full assignment workflow with grading and feedback
- **Dependencies**: Requires discussion threads, user enrollment, and notification system

### Technical Stack Context - Free Tier Optimized
[Source: docs/prd/technical-stack.md]
- **Frontend**: Next.js, Tailwind CSS (post editor and discussion interface)
- **Backend**: Supabase (Free Tier - 500MB database, 2GB bandwidth)
- **Database**: PostgreSQL via Supabase for posts and reply threading
- **File Storage**: Supabase Storage (1GB total - for post attachments)
- **Real-time**: Supabase Realtime for live post updates and notifications
- **Hosting**: Vercel (Free Tier)

### Data Models Extension
Extended database schema for student discussion participation:
```sql
-- Post edit history tracking
CREATE TABLE post_edit_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  post_id UUID REFERENCES discussion_posts(id) ON DELETE CASCADE,
  previous_content TEXT NOT NULL,
  previous_content_html TEXT,
  edit_reason TEXT,
  edited_by UUID REFERENCES users(id) ON DELETE SET NULL,
  edited_at TIMESTAMP DEFAULT NOW()
);

-- Post drafts for auto-saving
CREATE TABLE post_drafts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  thread_id UUID REFERENCES discussion_threads(id) ON DELETE CASCADE,
  parent_post_id UUID REFERENCES discussion_posts(id) ON DELETE CASCADE,
  author_id UUID REFERENCES users(id) ON DELETE CASCADE,
  draft_content TEXT,
  draft_content_html TEXT,
  attachments JSONB DEFAULT '[]', -- Temporary attachment references
  last_saved TIMESTAMP DEFAULT NOW(),
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(thread_id, parent_post_id, author_id) -- One draft per thread/reply per user
);

-- Post mentions for @username notifications
CREATE TABLE post_mentions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  post_id UUID REFERENCES discussion_posts(id) ON DELETE CASCADE,
  mentioned_user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  mentioned_by UUID REFERENCES users(id) ON DELETE CASCADE,
  mention_text VARCHAR(255), -- The actual @username text
  is_read BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(post_id, mentioned_user_id)
);

-- Discussion read status tracking
CREATE TABLE discussion_read_status (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  thread_id UUID REFERENCES discussion_threads(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  last_read_post_id UUID REFERENCES discussion_posts(id),
  last_read_at TIMESTAMP DEFAULT NOW(),
  unread_count INTEGER DEFAULT 0,
  UNIQUE(thread_id, user_id)
);

-- Post bookmarks for students
CREATE TABLE post_bookmarks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  post_id UUID REFERENCES discussion_posts(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  bookmark_note TEXT, -- Optional note about why bookmarked
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(post_id, user_id)
);

-- Discussion participation metrics
CREATE TABLE discussion_participation (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  thread_id UUID REFERENCES discussion_threads(id) ON DELETE CASCADE,
  course_id UUID REFERENCES courses(id) ON DELETE CASCADE,
  posts_count INTEGER DEFAULT 0,
  replies_count INTEGER DEFAULT 0,
  reactions_given INTEGER DEFAULT 0,
  reactions_received INTEGER DEFAULT 0,
  helpful_posts_count INTEGER DEFAULT 0,
  first_post_at TIMESTAMP,
  last_post_at TIMESTAMP,
  engagement_score DECIMAL(5,2) DEFAULT 0.0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, thread_id)
);
```

### File Locations
Based on Next.js conventions and student discussion participation:
- Post creation: `pages/courses/[courseId]/discussions/[threadId]/new-post.js` or `app/courses/[courseId]/discussions/[threadId]/new-post/page.js`
- Reply creation: `pages/courses/[courseId]/discussions/[threadId]/reply/[postId].js` or `app/courses/[courseId]/discussions/[threadId]/reply/[postId]/page.js`
- Post editing: `pages/courses/[courseId]/discussions/[threadId]/edit/[postId].js` or `app/courses/[courseId]/discussions/[threadId]/edit/[postId]/page.js`
- Post components: `components/discussions/PostEditor.js`, `components/discussions/PostView.js`
- Rich text components: `components/editor/RichTextEditor.js`, `components/editor/FormattingToolbar.js`
- Threading components: `components/discussions/ThreadedReplies.js`, `components/discussions/ReplyTree.js`
- Post utilities: `lib/postHelpers.js`, `lib/richTextUtils.js`
- Discussion hooks: `hooks/usePostEditor.js`, `hooks/useThreading.js`

### Free Tier Post Optimization
**Efficient Student Participation Strategy:**
```javascript
// Optimized post system for free tier
const PostOptimization = {
  // Rich text editor optimization
  editorOptimization: {
    debounceInterval: 1000, // 1 second debounce for auto-save
    maxContentLength: 10000, // 10k characters max per post
    imageCompression: 75, // Compress images to 75% quality
    maxAttachments: 3, // Limit attachments per post
    autoSaveInterval: 30000 // Auto-save every 30 seconds
  },
  
  // Threading and loading optimization
  threadingOptimization: {
    maxReplyDepth: 5, // Limit reply nesting depth
    repliesPerLoad: 10, // Load 10 replies at a time
    threadPreloading: 3, // Preload 3 levels of threading
    collapsedByDefault: true, // Collapse long threads by default
    virtualScrolling: true // Use virtual scrolling for long threads
  },
  
  // Post editing optimization
  editingOptimization: {
    editTimeLimit: 15 * 60 * 1000, // 15 minutes to edit
    maxEditHistory: 5, // Keep last 5 edit versions
    editDebounce: 2000, // 2 second debounce for edit saves
    conflictResolution: 'last_write_wins', // Simple conflict resolution
    offlineEditSupport: true // Support offline editing
  },
  
  // Performance optimization
  performanceOptimization: {
    postCaching: 50, // Cache last 50 viewed posts
    draftCaching: 10, // Cache last 10 drafts locally
    mentionCaching: 100, // Cache 100 users for @mentions
    searchDebounce: 500, // 500ms search debounce
    lazyLoadImages: true // Lazy load post images
  }
};
```

### Post Creation Interface Design
```jsx
// Comprehensive post creation and participation interface
const PostCreationSystem = () => {
  const [postContent, setPostContent] = useState('');
  const [isDraft, setIsDraft] = useState(false);
  const [attachments, setAttachments] = useState([]);
  const [mentions, setMentions] = useState([]);

  return (
    <PostCreationContainer>
      <PostEditor>
        <RichTextEditor 
          content={postContent}
          onChange={setPostContent}
          onMention={handleMention}
          onAutoSave={handleAutoSave}
          placeholder="Share your thoughts..."
        />
        
        <EditorToolbar>
          <FormattingControls />
          <AttachmentButton 
            onAttach={handleAttachment}
            maxAttachments={3}
          />
          <EmojiPicker onEmojiSelect={handleEmojiInsert} />
          <MentionSuggestions 
            users={courseUsers}
            onMentionSelect={handleMentionSelect}
          />
        </EditorToolbar>
        
        <AttachmentPreview 
          attachments={attachments}
          onRemove={removeAttachment}
        />
      </PostEditor>
      
      <PostActions>
        <DraftStatus 
          isDraft={isDraft}
          lastSaved={lastSavedTime}
        />
        
        <PostPreview 
          content={postContent}
          onPreview={showPreviewModal}
        />
        
        <PostSubmission>
          <CancelButton onClick={handleCancel} />
          <SaveDraftButton 
            onClick={saveDraft}
            disabled={!postContent.trim()}
          />
          <PublishButton 
            onClick={publishPost}
            disabled={!postContent.trim()}
          />
        </PostSubmission>
      </PostActions>
      
      <PostGuidelines>
        <CommunityGuidelines />
        <FormattingHelp />
      </PostGuidelines>
    </PostCreationContainer>
  );
};
```

### Rich Text Editor Implementation
**Advanced Text Formatting Features:**
```javascript
// Rich text editor for discussion posts
const RichTextEditor = {
  // Editor configuration
  editorConfig: {
    toolbar: [
      'bold', 'italic', 'underline', 'strikethrough',
      'heading1', 'heading2', 'heading3',
      'bulletList', 'orderedList',
      'blockquote', 'codeBlock',
      'link', 'image',
      'undo', 'redo'
    ],
    
    extensions: [
      'Bold', 'Italic', 'Underline', 'Strike',
      'Heading', 'BulletList', 'OrderedList',
      'Blockquote', 'CodeBlock', 'Link',
      'Image', 'History', 'Mention'
    ],
    
    limits: {
      maxLength: 10000,
      maxImages: 3,
      maxLinks: 10
    }
  },
  
  // Content processing
  contentProcessing: {
    sanitizeHTML: (html) => {
      // Use DOMPurify or similar to sanitize HTML content
      return sanitized_html;
    },
    
    extractMentions: (content) => {
      const mentionRegex = /@([a-zA-Z0-9_]+)/g;
      const mentions = [];
      let match;
      
      while ((match = mentionRegex.exec(content)) !== null) {
        mentions.push({
          username: match[1],
          position: match.index
        });
      }
      
      return mentions;
    },
    
    processLinks: (content) => {
      // Auto-link URLs and validate external links
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return content.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
    },
    
    generatePreview: (html) => {
      // Generate plain text preview for notifications
      const div = document.createElement('div');
      div.innerHTML = html;
      return div.textContent.substring(0, 200) + '...';
    }
  },
  
  // Auto-save functionality
  autoSave: {
    saveDraft: async (threadId, parentPostId, content, userId) => {
      return await supabase
        .from('post_drafts')
        .upsert({
          thread_id: threadId,
          parent_post_id: parentPostId,
          author_id: userId,
          draft_content: content.text,
          draft_content_html: content.html,
          last_saved: new Date()
        });
    },
    
    loadDraft: async (threadId, parentPostId, userId) => {
      const { data } = await supabase
        .from('post_drafts')
        .select('*')
        .eq('thread_id', threadId)
        .eq('parent_post_id', parentPostId || null)
        .eq('author_id', userId)
        .single();
      
      return data;
    },
    
    clearDraft: async (threadId, parentPostId, userId) => {
      return await supabase
        .from('post_drafts')
        .delete()
        .eq('thread_id', threadId)
        .eq('parent_post_id', parentPostId || null)
        .eq('author_id', userId);
    }
  }
};
```

### Threaded Conversation System
**Advanced Reply Threading:**
```javascript
// Threaded conversation management
const ThreadingSystem = {
  // Reply management
  replyManagement: {
    createReply: async (parentPostId, content, authorId) => {
      // Create the reply post
      const { data: reply } = await supabase
        .from('discussion_posts')
        .insert({
          thread_id: parentPost.thread_id,
          parent_post_id: parentPostId,
          author_id: authorId,
          content: content.text,
          content_html: content.html
        })
        .select()
        .single();
      
      // Update thread post count
      await supabase
        .from('discussion_threads')
        .update({
          post_count: supabase.raw('post_count + 1'),
          last_activity: new Date(),
          last_post_id: reply.id
        })
        .eq('id', parentPost.thread_id);
      
      // Notify parent post author
      await notifyReply(parentPost.author_id, reply);
      
      // Process mentions in reply
      await processMentions(reply.id, content.text);
      
      return reply;
    },
    
    buildReplyTree: async (threadId, maxDepth = 5) => {
      // Get all posts for the thread
      const { data: posts } = await supabase
        .from('discussion_posts')
        .select(`
          *,
          users(username, avatar_url),
          post_reactions(reaction_type, count),
          children:discussion_posts!parent_post_id(id)
        `)
        .eq('thread_id', threadId)
        .eq('is_deleted', false)
        .order('created_at', { ascending: true });
      
      // Build hierarchical tree structure
      return buildHierarchy(posts, null, 0, maxDepth);
    },
    
    getReplyChain: async (postId) => {
      // Get the full chain of replies to a specific post
      const { data: replies } = await supabase
        .from('discussion_posts')
        .select(`
          *,
          users(username, avatar_url)
        `)
        .eq('parent_post_id', postId)
        .eq('is_deleted', false)
        .order('created_at', { ascending: true });
      
      return replies;
    }
  },
  
  // Threading visualization
  threadVisualization: {
    generateThreadHTML: (replyTree, depth = 0) => {
      const maxDepth = 5;
      const indentClass = `ml-${Math.min(depth * 4, 20)}`;
      
      return replyTree.map(post => {
        const hasReplies = post.children && post.children.length > 0;
        const showReplies = depth < maxDepth;
        
        return `
          <div class="post-container ${indentClass}" data-post-id="${post.id}">
            <div class="post-content">
              ${renderPost(post)}
            </div>
            ${hasReplies && showReplies ? 
              this.generateThreadHTML(post.children, depth + 1) : ''}
            ${hasReplies && !showReplies ? 
              '<div class="load-more-replies">Load more replies...</div>' : ''}
          </div>
        `;
      }).join('');
    },
    
    calculateThreadDepth: (post, allPosts) => {
      let depth = 0;
      let currentPost = post;
      
      while (currentPost.parent_post_id) {
        depth++;
        currentPost = allPosts.find(p => p.id === currentPost.parent_post_id);
        if (!currentPost) break;
      }
      
      return depth;
    }
  },
  
  // Navigation and UX
  threadNavigation: {
    scrollToPost: (postId) => {
      const element = document.querySelector(`[data-post-id="${postId}"]`);
      if (element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        element.classList.add('highlighted');
        setTimeout(() => element.classList.remove('highlighted'), 3000);
      }
    },
    
    expandThread: async (postId) => {
      const replies = await ThreadingSystem.replyManagement.getReplyChain(postId);
      // Update UI to show expanded replies
      return replies;
    },
    
    collapseThread: (postId) => {
      const threadElement = document.querySelector(`[data-post-id="${postId}"]`);
      const replies = threadElement.querySelectorAll('.post-container');
      replies.forEach(reply => reply.style.display = 'none');
    }
  }
};
```

### Post Editing System
**Time-Limited Post Editing:**
```javascript
// Post editing with time limits and history
const PostEditingSystem = {
  // Edit permissions and timing
  editPermissions: {
    canEditPost: (post, userId) => {
      // Check if user is the author
      if (post.author_id !== userId) return false;
      
      // Check time limit (15 minutes)
      const editDeadline = new Date(post.created_at);
      editDeadline.setMinutes(editDeadline.getMinutes() + 15);
      
      return new Date() < editDeadline;
    },
    
    getTimeRemaining: (post) => {
      const editDeadline = new Date(post.created_at);
      editDeadline.setMinutes(editDeadline.getMinutes() + 15);
      const timeRemaining = editDeadline - new Date();
      
      return Math.max(0, timeRemaining);
    },
    
    showEditTimer: (timeRemaining) => {
      const minutes = Math.floor(timeRemaining / 60000);
      const seconds = Math.floor((timeRemaining % 60000) / 1000);
      return `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
  },
  
  // Edit history management
  editHistory: {
    saveEditHistory: async (postId, previousContent, editReason) => {
      return await supabase
        .from('post_edit_history')
        .insert({
          post_id: postId,
          previous_content: previousContent.text,
          previous_content_html: previousContent.html,
          edit_reason: editReason,
          edited_by: userId,
          edited_at: new Date()
        });
    },
    
    getEditHistory: async (postId) => {
      return await supabase
        .from('post_edit_history')
        .select(`
          *,
          users(username)
        `)
        .eq('post_id', postId)
        .order('edited_at', { ascending: false });
    },
    
    showEditIndicator: (post) => {
      if (post.is_edited) {
        return `
          <span class="edit-indicator">
            (edited ${formatTimeAgo(post.edited_at)})
            <button onclick="showEditHistory('${post.id}')">view history</button>
          </span>
        `;
      }
      return '';
    }
  },
  
  // Edit conflict resolution
  conflictResolution: {
    detectConflict: async (postId, lastKnownVersion) => {
      const { data: currentPost } = await supabase
        .from('discussion_posts')
        .select('updated_at, content')
        .eq('id', postId)
        .single();
      
      return new Date(currentPost.updated_at) > new Date(lastKnownVersion);
    },
    
    resolveConflict: async (postId, userContent, currentContent) => {
      // Simple last-write-wins for free tier
      // In production, could implement more sophisticated merging
      return {
        resolution: 'user_overwrites',
        content: userContent,
        warning: 'Your changes will overwrite recent edits by another user.'
      };
    }
  }
};
```

### Mention System
**User Mentions and Notifications:**
```javascript
// User mention system for discussions
const MentionSystem = {
  // Mention detection and processing
  mentionProcessing: {
    processMentions: async (postId, content) => {
      const mentions = extractMentions(content);
      
      for (const mention of mentions) {
        // Find user by username
        const { data: user } = await supabase
          .from('users')
          .select('id')
          .eq('username', mention.username)
          .single();
        
        if (user) {
          // Save mention record
          await supabase
            .from('post_mentions')
            .insert({
              post_id: postId,
              mentioned_user_id: user.id,
              mentioned_by: authorId,
              mention_text: `@${mention.username}`
            });
          
          // Send notification
          await notifyMention(user.id, postId);
        }
      }
    },
    
    getMentionSuggestions: async (query, courseId) => {
      return await supabase
        .from('enrollments')
        .select(`
          users(id, username, full_name, avatar_url)
        `)
        .eq('course_id', courseId)
        .ilike('users.username', `%${query}%`)
        .limit(10);
    },
    
    formatMentions: (content) => {
      const mentionRegex = /@([a-zA-Z0-9_]+)/g;
      return content.replace(mentionRegex, 
        '<span class="mention" data-username="$1">@$1</span>');
    }
  },
  
  // Mention notifications
  mentionNotifications: {
    notifyMention: async (userId, postId) => {
      const { data: post } = await supabase
        .from('discussion_posts')
        .select(`
          *,
          discussion_threads(thread_title, course_id),
          users(username)
        `)
        .eq('id', postId)
        .single();
      
      // Create notification
      await supabase
        .from('notifications')
        .insert({
          user_id: userId,
          type: 'mention',
          title: `${post.users.username} mentioned you`,
          content: `In "${post.discussion_threads.thread_title}"`,
          action_url: `/courses/${post.discussion_threads.course_id}/discussions/${post.thread_id}#post-${postId}`,
          is_read: false
        });
    },
    
    getMentionNotifications: async (userId) => {
      return await supabase
        .from('post_mentions')
        .select(`
          *,
          discussion_posts(content, thread_id),
          discussion_threads(thread_title, course_id),
          users:mentioned_by(username)
        `)
        .eq('mentioned_user_id', userId)
        .eq('is_read', false)
        .order('created_at', { ascending: false });
    }
  }
};
```

### Post Engagement Features
**Student Interaction Tools:**
```javascript
// Post engagement and interaction features
const PostEngagement = {
  // Post bookmarking
  bookmarking: {
    bookmarkPost: async (postId, userId, note = '') => {
      return await supabase
        .from('post_bookmarks')
        .upsert({
          post_id: postId,
          user_id: userId,
          bookmark_note: note
        });
    },
    
    getUserBookmarks: async (userId, courseId) => {
      return await supabase
        .from('post_bookmarks')
        .select(`
          *,
          discussion_posts(
            content,
            discussion_threads(thread_title, course_id)
          )
        `)
        .eq('user_id', userId)
        .eq('discussion_posts.discussion_threads.course_id', courseId)
        .order('created_at', { ascending: false });
    }
  },
  
  // Read status tracking
  readStatus: {
    markThreadAsRead: async (threadId, userId) => {
      // Get latest post in thread
      const { data: latestPost } = await supabase
        .from('discussion_posts')
        .select('id')
        .eq('thread_id', threadId)
        .order('created_at', { ascending: false })
        .limit(1)
        .single();
      
      return await supabase
        .from('discussion_read_status')
        .upsert({
          thread_id: threadId,
          user_id: userId,
          last_read_post_id: latestPost.id,
          last_read_at: new Date(),
          unread_count: 0
        });
    },
    
    getUnreadCount: async (threadId, userId) => {
      const { data } = await supabase
        .from('discussion_read_status')
        .select('unread_count')
        .eq('thread_id', threadId)
        .eq('user_id', userId)
        .single();
      
      return data?.unread_count || 0;
    }
  },
  
  // Participation tracking
  participationTracking: {
    trackPostCreation: async (userId, threadId, courseId) => {
      // Update participation metrics
      await supabase
        .from('discussion_participation')
        .upsert({
          user_id: userId,
          thread_id: threadId,
          course_id: courseId,
          posts_count: supabase.raw('posts_count + 1'),
          last_post_at: new Date(),
          updated_at: new Date()
        });
      
      // Award XP for participation
      await awardDiscussionXP(userId, 'post_created', 20);
    },
    
    calculateEngagementScore: async (userId, threadId) => {
      const { data } = await supabase
        .from('discussion_participation')
        .select('*')
        .eq('user_id', userId)
        .eq('thread_id', threadId)
        .single();
      
      if (!data) return 0;
      
      // Calculate engagement based on posts, replies, and reactions
      const score = (data.posts_count * 3) + 
                   (data.replies_count * 2) + 
                   (data.reactions_given * 1) + 
                   (data.helpful_posts_count * 5);
      
      return Math.min(score, 100); // Cap at 100
    }
  }
};
```

### Mobile Post Experience
**Touch-Optimized Discussion Interface:**
- **Mobile Editor**: Touch-friendly rich text editing with simplified toolbar
- **Swipe Actions**: Swipe to reply, bookmark, or react to posts
- **Collapsed Threading**: Smart thread collapsing for mobile viewing
- **Offline Drafts**: Save drafts offline and sync when connected
- **Voice Input**: Voice-to-text input for mobile posting

### Integration with Previous Systems
**Building on Complete LMS Foundation:**
```javascript
// Integration with existing LMS systems
const StudentParticipationIntegration = {
  // Progress tracking integration (Epic 3)
  progressIntegration: {
    participationTracking: {
      trackEngagement: true,
      updateXP: true,
      participationMetrics: true,
      helpfulnessScore: true
    },
    
    achievements: [
      'First Post',
      'Active Participant',
      'Helpful Contributor',
      'Discussion Maven'
    ]
  },
  
  // Course integration (Epic 2)
  courseIntegration: {
    enrollmentVerification: true, // Only enrolled students can post
    courseSpecificSettings: true, // Different participation rules per course
    instructorNotifications: true, // Notify instructors of student participation
    gradeBookIntegration: false // Save for future enhancements
  },
  
  // Assignment integration (Epic 4)
  assignmentIntegration: {
    assignmentDiscussions: true, // Link discussions to specific assignments
    submissionQuestions: true, // Q&A threads for assignment help
    peerCollaboration: false // Save for future enhancements
  }
};
```

### Performance Optimizations
**Free Tier Student Participation:**
- **Efficient Loading**: Lazy load post content and attachments
- **Smart Caching**: Cache user's recent posts and drafts
- **Optimized Editor**: Lightweight rich text editor with essential features
- **Threading Performance**: Efficient reply tree building and rendering
- **Auto-Save**: Smart auto-saving with debouncing and conflict detection

### Testing Requirements
Student discussion participation requires comprehensive testing:
- **Post Tests**: Creating, editing, and deleting posts
- **Reply Tests**: Threaded reply functionality and navigation
- **Editor Tests**: Rich text formatting and attachment handling
- **Mention Tests**: User mentions and notification system
- **Mobile Tests**: Touch interface and mobile-specific features

## Testing

### Testing Standards
Student discussion participation testing strategy:
- **Unit Tests**:
  - Post creation and editing logic (`lib/postHelpers.test.js`)
  - Rich text processing (`lib/richTextUtils.test.js`)
  - Threading algorithms (`lib/threadingSystem.test.js`)
  - Mention detection (`lib/mentionSystem.test.js`)
- **Component Tests**:
  - Rich text editor functionality
  - Post creation and reply interfaces
  - Threaded conversation display
  - Mobile post editor
- **Integration Tests**:
  - Complete post creation workflow
  - Reply threading and navigation
  - Mention notification system
  - Course enrollment verification
- **E2E Tests**:
  - Full student discussion participation journey
  - Cross-browser post editor testing
  - Mobile discussion interface testing
  - Real-time post updates
- **Performance Tests**:
  - Rich text editor performance with large content
  - Threading performance with deep conversations
  - Auto-save performance and conflict resolution
  - Mobile interface responsiveness

Test file locations:
- `__tests__/discussions/postCreation.test.js`
- `__tests__/api/discussionPosts.test.js`
- `__tests__/e2e/studentParticipation.test.js`
- `__tests__/components/postEditor.test.js`
- `__tests__/threading/replySystem.test.js`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-07-21 | 1.0 | Initial student discussion participation story | Scrum Master (Bob) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here after implementation*
