# Story 1.3: User Profile Management

## Status
Draft

## Story
**As a** user,
**I want to** manage my profile information,
**so that** my details are current and accurate

## Acceptance Criteria
1. User can view their profile information
2. User can update name, email, and avatar
3. Email changes require verification
4. Profile updates are saved and reflected immediately
5. Password can be changed with current password verification

## Tasks / Subtasks
- [ ] Create user profile viewing interface (AC: 1)
  - [ ] Build profile display component showing current user data
  - [ ] Fetch and display user information (name, email, role, avatar)
  - [ ] Add profile loading states and error handling
  - [ ] Create responsive profile layout with Tailwind CSS
- [ ] Implement profile editing functionality (AC: 2)
  - [ ] Create editable profile form with validation
  - [ ] Add name field with character limits and validation
  - [ ] Implement email field with format validation
  - [ ] Add avatar upload functionality with file size limits
  - [ ] Include role display (read-only for users)
- [ ] Add email verification system (AC: 3)
  - [ ] Implement email verification flow for email changes
  - [ ] Send verification emails for new email addresses
  - [ ] Create email verification confirmation page
  - [ ] Handle email verification status in UI
  - [ ] Prevent email changes until verification is complete
- [ ] Implement real-time profile updates (AC: 4)
  - [ ] Add auto-save functionality for profile changes
  - [ ] Implement optimistic UI updates
  - [ ] Show save status indicators (saving, saved, error)
  - [ ] Update authentication context with new profile data
  - [ ] Refresh UI components with updated profile information
- [ ] Create password change functionality (AC: 5)
  - [ ] Build secure password change form
  - [ ] Implement current password verification
  - [ ] Add new password validation (matching Story 1.1 requirements)
  - [ ] Include password confirmation field
  - [ ] Handle password change success/error states
- [ ] Add profile management security features (AC: 3, 5)
  - [ ] Implement session validation for sensitive operations
  - [ ] Add CSRF protection for profile updates
  - [ ] Log profile changes for security audit
  - [ ] Add rate limiting for profile update attempts

## Dev Notes

### Previous Story Context
This story builds on completed authentication stories:
- **Story 1.1**: Established user authentication, JWT tokens, and basic user data structure
- **Story 1.2**: Implemented role-based access control and user role management
- **Dependencies**: Requires authentication context, user session management, and role system

### Technical Stack Context
[Source: docs/prd/technical-stack.md]
- **Frontend**: Next.js, Tailwind CSS for responsive profile UI
- **Backend**: Supabase (Free Tier - chosen for completely free implementation)
- **Database**: PostgreSQL via Supabase (Free Tier: 500MB storage)
- **File Storage**: Supabase Storage (Free Tier: 1GB storage for avatars)

### Authentication Architecture
[Source: docs/architecture/core-components.md#Authentication]
- JWT-based session management with user profile data
- Authentication context maintains current user information
- Profile updates must be reflected in JWT tokens and session

### Data Models
[Source: docs/architecture/entity-relationship-overview-for-supabase.md]
- **Users** table structure: (id, name, role, email, avatar)
- All fields except role should be user-editable
- Email field requires verification process for changes
- Avatar field stores file URL or path to uploaded image

### File Locations
Based on Next.js conventions and extending from previous stories:
- Profile page: `pages/profile.js` or `app/profile/page.js`
- Profile components: `components/profile/ProfileView.js`, `components/profile/ProfileEdit.js`
- Avatar upload: `components/profile/AvatarUpload.js`
- Password change: `components/profile/PasswordChange.js`
- Profile utilities: `lib/profile.js`
- Profile validation: `utils/profileValidation.js`
- Profile hooks: `hooks/useProfile.js`

### Technical Requirements
- **Avatar Upload**: Support common image formats (JPG, PNG, WebP), max 5MB file size
- **Email Verification**: Must send verification email and confirm before email change takes effect
- **Password Security**: Same requirements as Story 1.1 (min 8 chars, special chars, numbers)
- **Real-time Updates**: Profile changes reflected immediately in UI and authentication context
- **Validation**: Client-side validation with server-side verification
- **Error Handling**: User-friendly error messages for all failure scenarios

### Profile Update Flow
```javascript
// Example profile update flow
1. User edits profile field
2. Client-side validation runs
3. Optimistic UI update shows changes
4. API call sends updates to backend
5. Backend validates and saves changes
6. Authentication context refreshes with new data
7. UI confirms save success or shows errors
```

### Security Considerations
- **Current Password Required**: Password changes must verify current password first
- **Email Verification**: New email addresses must be verified before becoming active
- **Session Validation**: Profile updates require valid, unexpired authentication
- **Audit Logging**: Profile changes logged for security monitoring
- **File Upload Security**: Avatar uploads validated for file type and size
- **Rate Limiting**: Prevent abuse of profile update endpoints

### Avatar Upload Integration
- **Storage Service**: Use Supabase Storage or Firebase Storage from architecture
- **File Processing**: Client-side image resizing and optimization
- **Upload States**: Loading, progress, success, and error states
- **Fallback Handling**: Default avatar for users without uploaded images

### Testing
Profile management requires comprehensive testing:
- **Unit Tests**: Profile validation functions, upload utilities
- **Integration Tests**: Profile update API calls, email verification flow
- **Component Tests**: Profile forms, avatar upload, password change
- **E2E Tests**: Complete profile management workflows
- **Security Tests**: Email verification, password change security

## Testing

### Testing Standards
Profile management testing strategy:
- **Unit Tests**: 
  - Profile validation functions (`utils/profileValidation.test.js`)
  - Profile data transformation utilities (`lib/profile.test.js`)
- **Component Tests**:
  - Profile view and edit components (`components/profile/*.test.js`)
  - Avatar upload functionality with file mocking
  - Password change form validation and submission
- **Integration Tests**:
  - Profile update API integration (`api/profile.test.js`)
  - Email verification flow end-to-end
  - Authentication context updates after profile changes
- **E2E Tests**:
  - Complete profile management user journey
  - Email verification workflow
  - Password change with various scenarios
- **Security Tests**:
  - Unauthorized profile access attempts
  - Email verification token validation
  - Password change security requirements

Test file locations:
- `__tests__/profile/profileComponents.test.js`
- `__tests__/api/profileApi.test.js`
- `__tests__/e2e/profileManagement.test.js`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-07-21 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

### üß™ Senior QA Review - Story 1.3: User Profile Management
**Reviewed by:** Quinn (Senior Developer & QA Architect)  
**Review Date:** July 21, 2025  
**Review Type:** Data Privacy, Security & User Experience Assessment

#### üìã **Overall Assessment: MODERATE QUALITY WITH PRIVACY CONCERNS** ‚≠ê‚≠ê‚≠ê‚ö†Ô∏è‚ö†Ô∏è
This story shows good user experience thinking but has significant data privacy and security gaps that must be addressed for an educational platform handling personal information.

---

#### ‚ö†Ô∏è **CRITICAL PRIVACY & SECURITY ISSUES**

**1. Insufficient Data Privacy Protection**
```javascript
// CURRENT: Basic profile management
profileData: { name, email, avatar, role }

// REQUIRED: Privacy-compliant profile system
const privacyCompliantProfile = {
  dataMinimization: {
    requiredFields: ['name', 'email'], // Only collect necessary data
    optionalFields: ['avatar', 'bio', 'preferences'],
    noSensitiveData: 'No SSN, phone, address collection',
    purposeLimitation: 'Data used only for educational platform functions'
  },
  
  consentManagement: {
    explicitConsent: 'Clear consent for profile data processing',
    withdrawalRights: 'Easy data deletion and account removal',
    dataPortability: 'Export profile data in machine-readable format',
    privacyNotice: 'Clear privacy policy linked in profile settings'
  },
  
  dataRetention: {
    retentionPeriod: 'Delete inactive accounts after 7 years',
    graduationCleanup: 'Archive student data upon graduation',
    gdprCompliance: '30-day deletion upon request',
    auditLogging: 'Log all data access and modifications'
  }
};
```

**2. Missing Educational Data Protection (FERPA)**
```javascript
// CRITICAL GAP: No FERPA compliance for educational records
// REQUIRED: Educational privacy protection
const ferpaCompliance = {
  educationalRecords: {
    definition: 'Profile linked to academic performance is educational record',
    parentalRights: 'Parents access student profiles under 18',
    disclosure: 'Strict controls on profile data sharing',
    directory: 'Opt-in/opt-out for directory information'
  },
  
  accessControls: {
    legitimateInterest: 'Only authorized staff access student profiles',
    auditTrail: 'Complete log of who accessed what student data',
    notification: 'Students notified of profile data access',
    emergencyAccess: 'Emergency contact protocols'
  },
  
  dataSharing: {
    prohibition: 'No profile data sharing without consent',
    exceptions: 'Safety emergencies and educational officials only',
    thirdParty: 'No external service access to student profiles',
    marketing: 'Strict prohibition on marketing use'
  }
};
```

**3. Inadequate Security Controls**
```javascript
// SECURITY GAPS: Basic security insufficient for sensitive data
// REQUIRED: Enhanced profile security
const profileSecurity = {
  authentication: {
    sensitiveOperations: 'Re-authentication for email/password changes',
    sessionValidation: 'Fresh token required for critical changes',
    mfaRequirement: 'Multi-factor auth for admin profile changes',
    suspiciousActivity: 'Lock account on unusual profile activity'
  },
  
  dataValidation: {
    inputSanitization: 'Prevent XSS in profile fields',
    fileUploadSecurity: 'Virus scanning for avatar uploads',
    emailVerification: 'Secure token-based email verification',
    profileIntegrity: 'Detect and prevent profile tampering'
  },
  
  privacyByDesign: {
    defaultPrivate: 'Profiles private by default',
    minimumDisclosure: 'Show only necessary information',
    purposeLimitation: 'Profile data used only for stated purposes',
    storageMinimization: 'Delete uploaded files after profile deletion'
  }
};
```

---

#### üîí **Enhanced Database Schema Required**

**1. Privacy-Compliant Profile Architecture**
```sql
-- REQUIRED: Privacy-enhanced user profile schema
CREATE TABLE user_profiles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  
  -- Required fields only
  display_name VARCHAR(100) NOT NULL,
  email VARCHAR(255) NOT NULL UNIQUE,
  
  -- Optional fields with explicit consent
  bio TEXT,
  avatar_url VARCHAR(500),
  timezone VARCHAR(50) DEFAULT 'UTC',
  language_preference VARCHAR(10) DEFAULT 'en',
  
  -- Privacy settings
  profile_visibility VARCHAR(20) DEFAULT 'private', -- private, course_only, public
  directory_opt_in BOOLEAN DEFAULT false, -- FERPA directory information
  marketing_opt_in BOOLEAN DEFAULT false,
  
  -- Data processing consent
  data_processing_consent BOOLEAN DEFAULT false,
  consent_date TIMESTAMP,
  consent_ip_address INET,
  privacy_policy_version VARCHAR(20),
  
  -- Data retention
  last_active TIMESTAMP DEFAULT NOW(),
  data_retention_until TIMESTAMP, -- Auto-deletion date
  deletion_requested BOOLEAN DEFAULT false,
  deletion_requested_at TIMESTAMP,
  
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- REQUIRED: Profile access audit log (FERPA requirement)
CREATE TABLE profile_access_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  profile_user_id UUID REFERENCES users(id),
  accessing_user_id UUID REFERENCES users(id),
  access_type VARCHAR(50) NOT NULL, -- view, edit, delete, export
  fields_accessed JSONB, -- Which profile fields were accessed
  purpose VARCHAR(100), -- Educational purpose for access
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- REQUIRED: Data export requests (GDPR compliance)
CREATE TABLE data_export_requests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  request_type VARCHAR(20) NOT NULL, -- 'export', 'deletion'
  status VARCHAR(20) DEFAULT 'pending', -- pending, processing, completed, failed
  export_data JSONB, -- Exported data
  requested_at TIMESTAMP DEFAULT NOW(),
  completed_at TIMESTAMP,
  expires_at TIMESTAMP DEFAULT (NOW() + INTERVAL '30 days')
);

-- REQUIRED: Avatar file management with privacy
CREATE TABLE profile_avatars (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  file_name VARCHAR(255) NOT NULL,
  file_size INTEGER NOT NULL,
  mime_type VARCHAR(100) NOT NULL,
  storage_path VARCHAR(500) NOT NULL,
  virus_scan_status VARCHAR(20) DEFAULT 'pending', -- pending, clean, infected
  upload_ip_address INET,
  created_at TIMESTAMP DEFAULT NOW(),
  expires_at TIMESTAMP -- Auto-delete orphaned files
);
```

**2. Privacy Controls Implementation**
```javascript
// REQUIRED: Comprehensive privacy management
const privacyControls = {
  dataAccess: {
    viewOwnProfile: async (userId) => {
      // Log access for audit trail
      await logProfileAccess(userId, userId, 'view', 'self_access');
      return await getUserProfile(userId);
    },
    
    viewStudentProfile: async (lecturerId, studentId, purpose) => {
      // Verify legitimate educational interest
      const authorized = await verifyEducationalAccess(lecturerId, studentId);
      if (!authorized) throw new Error('Unauthorized access');
      
      // Log access with purpose
      await logProfileAccess(studentId, lecturerId, 'view', purpose);
      return await getUserProfile(studentId, 'educational_context');
    },
    
    bulkProfileAccess: async (adminId, userIds, purpose) => {
      // Admin access requires special authorization
      await verifyAdminAccess(adminId);
      
      // Log bulk access
      for (const userId of userIds) {
        await logProfileAccess(userId, adminId, 'bulk_view', purpose);
      }
      
      return await getBulkProfiles(userIds, 'admin_context');
    }
  },
  
  dataModification: {
    updateProfile: async (userId, updates, changeReason) => {
      // Validate updates against privacy rules
      const validatedUpdates = await validateProfileUpdates(userId, updates);
      
      // Require re-authentication for sensitive changes
      if (includesSensitiveFields(updates)) {
        await requireFreshAuthentication(userId);
      }
      
      // Log changes with details
      await logProfileAccess(userId, userId, 'edit', changeReason);
      
      return await updateUserProfile(userId, validatedUpdates);
    },
    
    deleteProfile: async (userId, deletionType) => {
      // Handle different deletion types: user_request, admin_action, automatic
      const profile = await getUserProfile(userId);
      
      // GDPR: Export data before deletion if requested
      if (deletionType === 'user_request') {
        await createDataExport(userId);
      }
      
      // FERPA: Maintain educational records as required
      await archiveEducationalRecords(userId);
      
      // Secure deletion of files
      await secureDeleteAvatarFiles(userId);
      
      // Log deletion
      await logProfileAccess(userId, userId, 'delete', deletionType);
      
      return await deleteUserProfile(userId);
    }
  }
};
```

---

#### üîç **Implementation Improvements Required**

**1. Enhanced Validation & Security**
```javascript
// REQUIRED: Comprehensive validation system
const profileValidation = {
  inputValidation: {
    nameValidation: {
      minLength: 2,
      maxLength: 100,
      allowedChars: /^[a-zA-Z\s\-'\.]+$/,
      noScriptTags: true,
      sanitization: 'HTML entity encoding'
    },
    
    emailValidation: {
      formatCheck: 'RFC 5322 compliant regex',
      domainValidation: 'DNS MX record check',
      disposableEmailBlock: 'Block temporary email services',
      institutionEmail: 'Prefer institutional email addresses'
    },
    
    bioValidation: {
      maxLength: 500,
      contentFiltering: 'Block inappropriate content',
      linkValidation: 'Validate any URLs in bio',
      profanityFilter: 'Educational environment appropriate'
    }
  },
  
  fileUploadSecurity: {
    avatarValidation: {
      allowedTypes: ['image/jpeg', 'image/png', 'image/webp'],
      maxSize: '2MB', // Reduced from 5MB for free tier
      dimensionLimits: 'Max 1024x1024 pixels',
      compressionRequired: 'Auto-compress large images'
    },
    
    securityScanning: {
      virusScanning: 'Scan all uploaded files',
      metadataStripping: 'Remove EXIF data for privacy',
      formatValidation: 'Verify file headers match extension',
      quarantineUploads: 'Temporary holding before approval'
    }
  }
};
```

**2. User Experience with Privacy Focus**
```javascript
// REQUIRED: Privacy-focused UX design
const privacyUX = {
  consentManagement: {
    initialSetup: {
      privacyWizard: 'Guide users through privacy settings',
      consentExplanation: 'Clear explanation of data use',
      granularChoices: 'Separate consent for different data uses',
      easyWithdrawal: 'One-click consent withdrawal'
    },
    
    ongoing: {
      privacyDashboard: 'Central privacy settings management',
      dataUsageReport: 'Show how profile data is being used',
      accessLog: 'Who has viewed your profile',
      exportOptions: 'Download your data anytime'
    }
  },
  
  transparencyFeatures: {
    profileVisibility: 'Clear indicators of who can see what',
    dataSharing: 'Explicit notice before sharing profile data',
    purposeLabeling: 'Label why each field is requested',
    retentionNotice: 'Show how long data will be kept'
  }
};
```

---

#### üìä **Quality Metrics Assessment**

| Aspect | Current Score | Required Score | Critical Gaps |
|--------|---------------|----------------|---------------|
| **Data Privacy Compliance** | 3/10 | 9/10 | No GDPR/FERPA compliance framework |
| **Security Architecture** | 4/10 | 9/10 | Missing re-auth, audit logs, secure file handling |
| **User Consent Management** | 2/10 | 9/10 | No consent tracking or withdrawal mechanisms |
| **Data Minimization** | 5/10 | 8/10 | Collecting more data than necessary |
| **Access Controls** | 3/10 | 9/10 | No educational purpose validation |
| **Audit & Transparency** | 2/10 | 9/10 | No access logging or user transparency |
| **File Upload Security** | 4/10 | 8/10 | Basic validation, missing virus scanning |
| **Testing Coverage** | 6/10 | 8/10 | Missing privacy and security test scenarios |

**Overall Privacy & Security Score: 3.6/10** - **UNACCEPTABLE FOR EDUCATIONAL PLATFORM**

---

#### üéØ **CRITICAL Action Items - Must Implement**

**BLOCKER ISSUES:**
1. **Implement FERPA Compliance Framework** - Educational records protection
2. **Add GDPR Data Rights Support** - Data export, deletion, portability
3. **Create Comprehensive Audit Logging** - Track all profile data access
4. **Implement Educational Purpose Validation** - Verify legitimate access reasons
5. **Add Privacy Consent Management** - Granular consent tracking and withdrawal

**HIGH PRIORITY:**
1. **Enhanced File Upload Security** - Virus scanning and metadata stripping
2. **Re-authentication for Sensitive Changes** - Email/password change security
3. **Privacy Dashboard for Users** - Transparency and control features
4. **Data Retention Automation** - Automatic cleanup of old data

**MEDIUM PRIORITY:**
1. **Profile Visibility Controls** - Fine-grained sharing permissions
2. **Suspicious Activity Detection** - Unusual profile access patterns
3. **Multi-language Privacy Notices** - Internationalization support
4. **Integration with Learning Analytics** - Privacy-preserving analytics

---

#### üõ°Ô∏è **Educational Privacy Compliance**

```javascript
// REQUIRED: Educational privacy compliance framework
const educationalPrivacy = {
  ferpaCompliance: {
    educationalRecords: {
      definition: 'Profile data linked to academic performance',
      parentalRights: 'Parent access for students under 18',
      disclosure: 'Strict controls on profile data sharing',
      directoryInfo: 'Opt-in for basic profile information sharing'
    },
    
    accessControls: {
      legitimateInterest: 'Educational purpose required for access',
      auditTrail: 'Complete log of educational record access',
      notification: 'Students notified of profile access',
      emergencyProtocol: 'Emergency access procedures'
    }
  },
  
  gdprCompliance: {
    lawfulBasis: 'Clear legal basis for profile data processing',
    dataRights: 'Access, rectification, erasure, portability',
    consentManagement: 'Granular consent with easy withdrawal',
    dataProtectionOfficer: 'DPO contact information in profile'
  },
  
  institutionalCompliance: {
    policyIntegration: 'Align with institutional privacy policies',
    trainingRequirements: 'Staff training on profile privacy',
    incidentResponse: 'Privacy breach response procedures',
    regulatoryReporting: 'Compliance reporting mechanisms'
  }
};
```

---

#### üìù **Final Assessment & Recommendations**

**CRITICAL FINDING:** This profile management story lacks fundamental privacy protections required for an educational platform handling student personal information. The current implementation could expose the institution to significant legal and regulatory violations.

**MAJOR PRIVACY CONCERNS:**
- **No FERPA Compliance** - Missing educational records protection
- **No GDPR Data Rights** - Cannot handle user data requests
- **Insufficient Audit Logging** - Cannot track profile data access
- **Missing Consent Management** - No framework for privacy consent

**RECOMMENDATION:** **MAJOR PRIVACY ENHANCEMENT REQUIRED**

**Implementation Priority:**
1. **Phase 1 (Compliance Foundation):** Implement FERPA/GDPR compliance framework
2. **Phase 2 (Security Enhancement):** Add comprehensive audit logging and access controls
3. **Phase 3 (User Rights):** Build privacy dashboard and data rights features
4. **Phase 4 (Advanced Features):** Add advanced privacy and security features

**Dependencies:** This story is **BLOCKED** until Stories 1.1 and 1.2 security issues are resolved, as profile management depends on secure authentication and authorization.

---

**QA Status:** üî¥ **BLOCKED - CRITICAL PRIVACY GAPS**  
**Privacy Compliance:** ‚ùå **NOT COMPLIANT** - Major privacy framework required  
**Next Review:** After educational privacy compliance is implemented
