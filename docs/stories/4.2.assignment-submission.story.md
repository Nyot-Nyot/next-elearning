# Story 4.2: Assignment Submission System

## Status
Draft

## Story
**As a** student,
**I want to** submit assignments for my courses,
**so that** I can complete my coursework and receive grades from my lecturers

## Acceptance Criteria
1. Students can view available assignments with clear requirements
2. Multiple submission types are supported (file upload, text entry, quiz responses)
3. Submission validation ensures requirements are met before submission
4. Students can track submission status and view feedback
5. Late submissions are handled according to assignment policies

## Tasks / Subtasks
- [ ] Build assignment viewing interface for students (AC: 1)
  - [ ] Create assignment detail page with requirements and deadlines
  - [ ] Display assignment instructions and grading criteria
  - [ ] Show submission status (not started, in progress, submitted, graded)
  - [ ] Add assignment deadline countdown and late penalty warnings
  - [ ] Implement assignment search and filtering for student dashboard
- [ ] Implement multi-type submission system (AC: 2)
  - [ ] Build file upload submission with drag-and-drop interface
  - [ ] Create text/essay submission with rich text editor
  - [ ] Add quiz submission with question navigation and timer
  - [ ] Implement project milestone submission tracking
  - [ ] Create group assignment submission coordination
- [ ] Add submission validation and safety checks (AC: 3)
  - [ ] Validate file types, sizes, and naming conventions
  - [ ] Check word count limits for text submissions
  - [ ] Verify quiz completion and required answers
  - [ ] Implement submission attempt limit enforcement
  - [ ] Add submission confirmation and receipt generation
- [ ] Build submission tracking and feedback system (AC: 4)
  - [ ] Create submission history with version tracking
  - [ ] Display grading status and score notifications
  - [ ] Show detailed feedback and comments from lecturers
  - [ ] Add submission analytics and improvement suggestions
  - [ ] Implement grade appeal and resubmission request system
- [ ] Handle late submissions and policy enforcement (AC: 5)
  - [ ] Calculate and display late penalty amounts
  - [ ] Implement automatic deadline enforcement
  - [ ] Add grace period handling for technical issues
  - [ ] Create late submission approval workflow
  - [ ] Build deadline extension request system
- [ ] Optimize submission system for free tier (AC: 1-5)
  - [ ] Implement chunked file uploads for large submissions
  - [ ] Cache submission data to reduce API calls
  - [ ] Optimize submission validation on client-side
  - [ ] Create efficient submission storage and retrieval
  - [ ] Add submission compression and optimization

## Dev Notes

### Previous Story Context
This story builds on the assignment creation foundation:
- **Story 4.1**: Assignment creation and management system
- **Epic 1 (1.1-1.3)**: Student authentication and role management
- **Epic 2 (2.1-2.3)**: Course enrollment and access control
- **Epic 3 (3.1-3.3)**: Student dashboard, calendar, and progress tracking
- **Dependencies**: Requires assignment data, student enrollment, and progress tracking integration

### Technical Stack Context - Free Tier Optimized
[Source: docs/prd/technical-stack.md]
- **Frontend**: Next.js, Tailwind CSS (submission forms and file handling)
- **Backend**: Supabase (Free Tier - 500MB database, 2GB bandwidth)
- **Database**: PostgreSQL via Supabase for submission tracking and grading
- **File Storage**: Supabase Storage (1GB total - efficient allocation for submissions)
- **Rich Text**: React-based editor for text submissions (Tiptap or similar)
- **File Handling**: Client-side compression and validation
- **Hosting**: Vercel (Free Tier)

### Data Models Extension
Extended database schema for submission system:
```sql
-- Assignment submissions
CREATE TABLE assignment_submissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  assignment_id UUID REFERENCES assignments(id) ON DELETE CASCADE,
  student_id UUID REFERENCES users(id) ON DELETE CASCADE,
  submission_type VARCHAR(50) NOT NULL, -- 'file', 'text', 'quiz', 'project'
  submission_data JSONB, -- Flexible storage for different submission types
  file_paths TEXT[], -- Array of file paths for file submissions
  submission_text TEXT, -- For text/essay submissions
  word_count INTEGER, -- Calculated word count for text submissions
  submission_status VARCHAR(20) DEFAULT 'draft', -- 'draft', 'submitted', 'graded', 'returned'
  attempt_number INTEGER DEFAULT 1,
  submitted_at TIMESTAMP,
  is_late BOOLEAN DEFAULT false,
  late_penalty_applied DECIMAL(5,2) DEFAULT 0,
  grade DECIMAL(8,2),
  feedback TEXT,
  graded_at TIMESTAMP,
  graded_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(assignment_id, student_id, attempt_number)
);

-- Submission files tracking
CREATE TABLE submission_files (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  submission_id UUID REFERENCES assignment_submissions(id) ON DELETE CASCADE,
  original_filename VARCHAR(255) NOT NULL,
  stored_filename VARCHAR(255) NOT NULL,
  file_path VARCHAR(500) NOT NULL,
  file_size_bytes BIGINT NOT NULL,
  file_type VARCHAR(100) NOT NULL,
  upload_status VARCHAR(20) DEFAULT 'uploading', -- 'uploading', 'completed', 'failed'
  uploaded_at TIMESTAMP DEFAULT NOW()
);

-- Quiz responses (for quiz-type assignments)
CREATE TABLE quiz_responses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  submission_id UUID REFERENCES assignment_submissions(id) ON DELETE CASCADE,
  question_id VARCHAR(100) NOT NULL,
  question_text TEXT NOT NULL,
  response_data JSONB NOT NULL, -- Stores answer data based on question type
  is_correct BOOLEAN,
  points_awarded DECIMAL(6,2),
  time_spent_seconds INTEGER,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Group submission coordination
CREATE TABLE group_submissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  assignment_id UUID REFERENCES assignments(id) ON DELETE CASCADE,
  group_id UUID REFERENCES assignment_groups(id) ON DELETE CASCADE,
  primary_submitter_id UUID REFERENCES users(id) ON DELETE CASCADE,
  submission_id UUID REFERENCES assignment_submissions(id) ON DELETE CASCADE,
  all_members_approved BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Submission feedback and rubric scores
CREATE TABLE submission_rubric_scores (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  submission_id UUID REFERENCES assignment_submissions(id) ON DELETE CASCADE,
  rubric_criterion_id UUID REFERENCES assignment_rubrics(id) ON DELETE CASCADE,
  points_awarded DECIMAL(6,2) NOT NULL,
  feedback_text TEXT,
  performance_level VARCHAR(50),
  created_at TIMESTAMP DEFAULT NOW()
);

-- Late submission requests
CREATE TABLE late_submission_requests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  assignment_id UUID REFERENCES assignments(id) ON DELETE CASCADE,
  student_id UUID REFERENCES users(id) ON DELETE CASCADE,
  reason TEXT NOT NULL,
  requested_extension_until TIMESTAMP NOT NULL,
  status VARCHAR(20) DEFAULT 'pending', -- 'pending', 'approved', 'denied'
  lecturer_response TEXT,
  processed_by UUID REFERENCES users(id),
  processed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Submission version history
CREATE TABLE submission_versions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  submission_id UUID REFERENCES assignment_submissions(id) ON DELETE CASCADE,
  version_number INTEGER NOT NULL,
  submission_data JSONB,
  file_paths TEXT[],
  submission_text TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### File Locations
Based on Next.js conventions and submission system:
- Submission pages: `pages/assignments/[id]/submit.js` or `app/assignments/[id]/submit/page.js`
- Submission view: `pages/assignments/[id]/submission.js` or `app/assignments/[id]/submission/page.js`
- Student assignments: `pages/student/assignments.js` or `app/student/assignments/page.js`
- Submission components: `components/submissions/SubmissionForm.js`, `components/submissions/FileUpload.js`
- Submission types: `components/submissions/TextSubmission.js`, `components/submissions/QuizSubmission.js`
- Submission tracking: `components/submissions/SubmissionStatus.js`, `components/submissions/SubmissionHistory.js`
- Submission utilities: `lib/submissionValidation.js`, `lib/fileUploadHelpers.js`
- Submission hooks: `hooks/useSubmission.js`, `hooks/useFileUpload.js`

### Free Tier Submission Optimization
**Efficient Submission Handling Strategy:**
```javascript
// Optimized submission system for free tier
const SubmissionOptimization = {
  // File upload optimization
  fileUpload: {
    maxFileSize: 25, // 25MB max per file (within free tier limits)
    compression: {
      images: 80, // 80% quality for images
      documents: true, // Compress PDF and Office docs
      enableClientSide: true
    },
    chunkedUpload: {
      chunkSize: 5, // 5MB chunks for large files
      maxRetries: 3,
      resumable: true
    }
  },
  
  // Submission caching strategy
  cacheStrategy: {
    draftSubmissions: 30, // Cache drafts for 30 minutes
    submissionHistory: 60, // Cache history for 1 hour
    assignmentDetails: 15, // Cache assignment info for 15 minutes
    feedback: 120 // Cache feedback for 2 hours
  },
  
  // Database optimization
  dbOptimization: {
    batchInserts: true, // Batch submission data inserts
    efficientQueries: true, // Use optimized queries for submission lists
    indexing: ['student_id', 'assignment_id', 'submitted_at'], // Key indexes
    pagination: 20 // Paginate submission lists
  }
};
```

### Submission Interface Design
```jsx
// Comprehensive submission system interface
const SubmissionSystem = () => {
  const [assignment, setAssignment] = useState(null);
  const [submission, setSubmission] = useState({
    type: 'file',
    files: [],
    textContent: '',
    quizResponses: {}
  });

  return (
    <SubmissionContainer>
      <AssignmentHeader>
        <AssignmentTitle>{assignment.title}</AssignmentTitle>
        <DeadlineCountdown dueDate={assignment.due_date} />
        <SubmissionStatus status={submission.status} />
      </AssignmentHeader>
      
      <AssignmentInstructions>
        <InstructionsPanel content={assignment.instructions} />
        <RequirementsChecklist requirements={assignment.requirements} />
        <GradingRubric rubric={assignment.rubric} />
      </AssignmentInstructions>
      
      <SubmissionInterface>
        {assignment.type === 'file_upload' && (
          <FileUploadSection>
            <DragDropUpload />
            <FileList files={submission.files} />
            <FileValidation requirements={assignment.fileRequirements} />
          </FileUploadSection>
        )}
        
        {assignment.type === 'text' && (
          <TextSubmissionSection>
            <RichTextEditor />
            <WordCountTracker 
              current={submission.wordCount}
              min={assignment.word_count_min}
              max={assignment.word_count_max}
            />
          </TextSubmissionSection>
        )}
        
        {assignment.type === 'quiz' && (
          <QuizSubmissionSection>
            <QuestionNavigation />
            <QuizTimer timeLimit={assignment.timeLimit} />
            <QuestionRenderer questions={assignment.questions} />
          </QuizSubmissionSection>
        )}
      </SubmissionInterface>
      
      <SubmissionActions>
        <SaveDraftButton />
        <PreviewSubmissionButton />
        <SubmitButton disabled={!isValidSubmission} />
        <SubmissionHistory submissions={previousSubmissions} />
      </SubmissionActions>
    </SubmissionContainer>
  );
};
```

### Multi-Type Submission Support
**Comprehensive Submission Type Handling:**
```javascript
// Submission type configurations and handlers
const SubmissionTypes = {
  file_upload: {
    validation: {
      fileTypes: (files, allowedTypes) => {
        return files.every(file => 
          allowedTypes.some(type => file.name.toLowerCase().endsWith(type))
        );
      },
      fileSize: (files, maxSize) => {
        return files.every(file => file.size <= maxSize * 1024 * 1024);
      },
      fileCount: (files, maxFiles) => files.length <= maxFiles
    },
    
    upload: async (files, assignmentId, studentId) => {
      const uploadPromises = files.map(file => 
        uploadFileWithProgress(file, `submissions/${assignmentId}/${studentId}/`)
      );
      return await Promise.all(uploadPromises);
    }
  },
  
  text_essay: {
    validation: {
      wordCount: (text, min, max) => {
        const count = text.trim().split(/\s+/).length;
        return count >= min && count <= max;
      },
      contentLength: (text, maxChars) => text.length <= maxChars,
      requiredSections: (text, sections) => {
        return sections.every(section => 
          text.toLowerCase().includes(section.toLowerCase())
        );
      }
    },
    
    processing: {
      extractWordCount: (text) => text.trim().split(/\s+/).length,
      sanitizeContent: (text) => text.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, ''),
      generatePreview: (text) => text.substring(0, 500) + '...'
    }
  },
  
  quiz_multiple_choice: {
    validation: {
      allAnswered: (responses, questions) => {
        return questions.every(q => responses[q.id] !== undefined);
      },
      timeLimit: (startTime, limit) => {
        return (Date.now() - startTime) <= (limit * 60 * 1000);
      }
    },
    
    grading: {
      autoGrade: (responses, answerKey) => {
        let totalPoints = 0;
        let earnedPoints = 0;
        
        Object.entries(responses).forEach(([questionId, response]) => {
          const question = answerKey[questionId];
          totalPoints += question.points;
          
          if (question.type === 'multiple_choice') {
            if (response === question.correctAnswer) {
              earnedPoints += question.points;
            }
          } else if (question.type === 'true_false') {
            if (response === question.correctAnswer) {
              earnedPoints += question.points;
            }
          }
        });
        
        return { earnedPoints, totalPoints, percentage: (earnedPoints / totalPoints) * 100 };
      }
    }
  }
};
```

### Submission Workflow and Status Management
**Complete Submission Lifecycle:**
```javascript
// Submission workflow management
const SubmissionWorkflow = {
  states: {
    NOT_STARTED: 'not_started',
    DRAFT: 'draft',
    IN_PROGRESS: 'in_progress',
    SUBMITTED: 'submitted',
    GRADED: 'graded',
    RETURNED: 'returned'
  },
  
  transitions: {
    startSubmission: (assignmentId, studentId) => {
      return createDraftSubmission(assignmentId, studentId);
    },
    
    saveDraft: async (submissionId, data) => {
      await updateSubmission(submissionId, {
        ...data,
        status: 'draft',
        updated_at: new Date()
      });
    },
    
    submitForGrading: async (submissionId, finalData) => {
      const submission = await updateSubmission(submissionId, {
        ...finalData,
        status: 'submitted',
        submitted_at: new Date(),
        is_late: isAfterDeadline(finalData.assignment.due_date)
      });
      
      // Update progress tracking
      await updateStudentProgress(submission.student_id, submission.assignment_id);
      
      // Send notifications
      await notifyLecturerOfSubmission(submission);
      
      return submission;
    }
  },
  
  validation: {
    canSubmit: (assignment, submission) => {
      const withinDeadline = !isAfterDeadline(assignment.due_date) || assignment.allow_late_submissions;
      const hasAttempts = submission.attempt_number <= assignment.max_attempts;
      const meetsRequirements = validateSubmissionRequirements(assignment, submission);
      
      return withinDeadline && hasAttempts && meetsRequirements;
    }
  }
};
```

### Late Submission Handling
**Comprehensive Late Submission Management:**
```javascript
// Late submission policy enforcement
const LateSubmissionManager = {
  // Calculate late penalty
  calculateLatePenalty: (dueDate, submissionDate, penaltyRate, maxLateDays) => {
    const daysLate = Math.ceil((submissionDate - dueDate) / (1000 * 60 * 60 * 24));
    
    if (daysLate <= 0) return 0;
    if (daysLate > maxLateDays) return 100; // No credit
    
    return Math.min(daysLate * penaltyRate, 100);
  },
  
  // Handle late submission requests
  requestExtension: async (assignmentId, studentId, reason, requestedDate) => {
    return await createExtensionRequest({
      assignment_id: assignmentId,
      student_id: studentId,
      reason: reason,
      requested_extension_until: requestedDate,
      status: 'pending'
    });
  },
  
  // Grace period for technical issues
  gracePeriodPolicy: {
    duration: 15, // 15 minutes grace period
    eligibleReasons: ['technical_failure', 'network_issue', 'server_error'],
    maxUsesPerSemester: 2
  },
  
  // Automatic deadline warnings
  deadlineWarnings: {
    send24HourWarning: true,
    send1HourWarning: true,
    send15MinuteWarning: true,
    sendOverdueNotification: true
  }
};
```

### File Upload System for Free Tier
**Optimized File Handling:**
```javascript
// Free tier optimized file upload system
const FileUploadSystem = {
  // Client-side compression before upload
  compression: {
    images: async (file) => {
      return await compressImage(file, {
        quality: 0.8,
        maxWidth: 1920,
        maxHeight: 1080
      });
    },
    
    documents: async (file) => {
      // Basic document optimization
      return file; // PDF compression would require paid services
    }
  },
  
  // Progressive upload with progress tracking
  upload: async (file, path, onProgress) => {
    const compressedFile = await compressIfNeeded(file);
    
    return await supabase.storage
      .from('submissions')
      .upload(path, compressedFile, {
        cacheControl: '3600',
        upsert: false,
        onUploadProgress: onProgress
      });
  },
  
  // File validation before upload
  validation: {
    validateFile: (file, requirements) => {
      const errors = [];
      
      // Check file type
      if (!requirements.allowedTypes.includes(getFileExtension(file.name))) {
        errors.push(`File type ${getFileExtension(file.name)} not allowed`);
      }
      
      // Check file size
      if (file.size > requirements.maxSize * 1024 * 1024) {
        errors.push(`File size exceeds ${requirements.maxSize}MB limit`);
      }
      
      // Check filename
      if (!/^[a-zA-Z0-9._-]+$/.test(file.name)) {
        errors.push('Filename contains invalid characters');
      }
      
      return errors;
    }
  }
};
```

### Mobile Submission Experience
**Touch-Optimized Submission Interface:**
- **Mobile File Selection**: Camera integration for photo submissions
- **Touch-Friendly Forms**: Large buttons and touch targets
- **Swipe Navigation**: Swipe between submission steps
- **Offline Support**: Save drafts offline and sync when connected
- **Progress Indicators**: Clear visual progress through submission process

### Integration with Progress Tracking (Epic 3)
**Submission Progress Integration:**
```javascript
// Integration with existing progress tracking from Story 3.3
const SubmissionProgressIntegration = {
  // Update progress when submission is made
  updateProgress: async (studentId, assignmentId, submissionData) => {
    await updateStudentProgress(studentId, {
      assignments_completed: increment(1),
      last_activity: new Date(),
      xp_points: increment(getXPForSubmission(submissionData))
    });
    
    // Check for achievements
    await checkSubmissionAchievements(studentId, submissionData);
  },
  
  // XP rewards for submissions
  xpRewards: {
    onTimeSubmission: 25,
    earlySubmission: 35,
    firstSubmission: 50,
    perfectQuizScore: 40,
    comprehensiveEssay: 30
  },
  
  // Achievement triggers
  achievements: [
    {
      id: 'perfect_quiz',
      trigger: 'quiz_score_100',
      xpReward: 100
    },
    {
      id: 'early_bird',
      trigger: 'submit_24_hours_early',
      xpReward: 50
    },
    {
      id: 'consistent_submitter',
      trigger: 'submit_5_assignments_on_time',
      xpReward: 200
    }
  ]
};
```

### Security and Data Protection
**Submission Security Measures:**
```javascript
// Security considerations for submission system
const SubmissionSecurity = {
  // File security
  fileValidation: {
    virusScanning: false, // Not available in free tier
    malwareDetection: false, // Not available in free tier
    fileTypeVerification: true, // Client-side MIME type checking
    contentValidation: true // Basic content structure validation
  },
  
  // Submission integrity
  integrityChecks: {
    checksumValidation: true,
    timestampVerification: true,
    studentOwnershipVerification: true,
    attemptLimitEnforcement: true
  },
  
  // Privacy protection
  privacy: {
    encryptSensitiveData: false, // Basic free tier doesn't include encryption
    accessLogging: true,
    dataRetentionPolicy: '7_years',
    gdprCompliance: true
  }
};
```

### Performance Optimizations
**Free Tier Performance Strategy:**
- **Lazy Loading**: Load submission history on demand
- **Efficient Queries**: Optimize database queries for submission lists
- **Client-Side Validation**: Reduce server load with client validation
- **Caching Strategy**: Cache frequently accessed submission data
- **Batch Operations**: Group multiple submission operations

### User Experience Features
- **Auto-Save**: Automatically save draft submissions
- **Submission Receipts**: Generate confirmation receipts for submissions
- **Progress Indicators**: Show completion progress during submission
- **Error Recovery**: Graceful handling of upload failures
- **Accessibility**: Screen reader support for all submission interfaces
- **Multi-Language**: Support for non-English submissions

### Testing Requirements
Submission system requires extensive testing:
- **File Upload**: Various file types, sizes, and edge cases
- **Form Validation**: All submission type validation rules
- **Late Submission**: Penalty calculations and deadline enforcement
- **Permission Tests**: Student access control and submission rights
- **Mobile Testing**: Touch interface and offline capabilities

## Testing

### Testing Standards
Assignment submission system testing strategy:
- **Unit Tests**:
  - Submission validation functions (`lib/submissionValidation.test.js`)
  - File upload helpers and compression (`lib/fileUploadHelpers.test.js`)
  - Late penalty calculations (`lib/latePenaltyCalculations.test.js`)
  - Quiz auto-grading algorithms (`lib/quizGrading.test.js`)
- **Component Tests**:
  - File upload with drag-and-drop functionality
  - Text editor for essay submissions
  - Quiz interface with timer and navigation
  - Submission status and progress tracking
- **Integration Tests**:
  - Complete submission workflow (`api/submissions.test.js`)
  - File storage integration with Supabase Storage
  - Progress tracking updates on submission
  - Calendar integration for deadline tracking
- **E2E Tests**:
  - Full submission process for each submission type
  - Late submission handling and penalty application
  - Group submission coordination
  - Mobile submission experience
- **Performance Tests**:
  - Large file upload performance and chunking
  - Submission list loading with pagination
  - Mobile submission interface responsiveness
  - Concurrent submission handling

Test file locations:
- `__tests__/submissions/submissionWorkflow.test.js`
- `__tests__/api/submissionApi.test.js`
- `__tests__/e2e/submissionSystem.test.js`
- `__tests__/components/submissionComponents.test.js`
- `__tests__/utils/fileUpload.test.js`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-07-21 | 1.0 | Initial submission system story with multi-type support | Scrum Master (Bob) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here after implementation*
