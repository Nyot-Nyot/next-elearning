# Story 1.3: Admin User Role Assignment and Management

## Status
Draft

## Story
**As an** admin,  
**I want** to assign or change user roles,  
**so that** I can manage access permissions and ensure users have appropriate system privileges

## Acceptance Criteria
1. Admin can view a list of all users with their current roles
2. Admin can assign roles (Student, Lecturer, Administrator) to new users
3. Admin can change existing user roles from one type to another
4. Role changes take effect immediately and update user session/permissions
5. Only users with Administrator role can access user management features
6. System logs all role assignment and change activities for audit purposes
7. Admin receives confirmation when role changes are successfully applied

## Tasks / Subtasks

- [ ] Task 1: Create user management database operations (AC: 1, 2, 3, 6)
  - [ ] Add Prisma queries for user listing with roles
  - [ ] Create user role update operations
  - [ ] Implement role assignment for new users
  - [ ] Add audit logging for role changes
  - [ ] Add Zod validation for role assignment requests

- [ ] Task 2: Build admin user management API endpoints (AC: 2, 3, 4, 5)
  - [ ] Create Server Action for fetching all users with roles
  - [ ] Create Server Action for updating user roles
  - [ ] Add admin role verification middleware for these endpoints
  - [ ] Implement immediate session invalidation for role changes
  - [ ] Add error handling for role assignment operations

- [ ] Task 3: Create user management UI components (AC: 1, 2, 3, 7)
  - [ ] Build user list component showing current roles
  - [ ] Create role assignment dropdown/selector component
  - [ ] Add role change confirmation dialog
  - [ ] Implement success/error feedback notifications
  - [ ] Style components with shadcn/ui and TailwindCSS

- [ ] Task 4: Integrate user management into admin dashboard (AC: 5)
  - [ ] Add user management page to `/dashboard/admin`
  - [ ] Create navigation link to user management
  - [ ] Ensure proper access control (admin only)
  - [ ] Add breadcrumb navigation and page titles

- [ ] Task 5: Implement real-time role change effects (AC: 4)
  - [ ] Force session refresh when user role changes
  - [ ] Update JWT token with new role information
  - [ ] Trigger automatic redirect if user loses current dashboard access
  - [ ] Handle concurrent session management

- [ ] Task 6: Add audit logging and admin controls (AC: 6, 7)
  - [ ] Create audit log database schema/table
  - [ ] Log all role assignment and change events
  - [ ] Add timestamp, admin user, target user, old/new roles to logs
  - [ ] Create audit log viewing interface for admins
  - [ ] Add confirmation messages for successful operations

- [ ] Task 7: Test role management functionality (AC: 1, 2, 3, 4, 5, 6, 7)
  - [ ] Test user listing and role display
  - [ ] Test role assignments for new users
  - [ ] Test role changes for existing users
  - [ ] Test immediate permission updates after role changes
  - [ ] Test access control (non-admins cannot access)
  - [ ] Test audit logging captures all events
  - [ ] Test UI feedback and error handling

## Dev Notes

### Previous Story Insights
**Story 1.1** established:
- BetterAuth authentication with user registration/login
- User model in database with role support
- Basic JWT session management

**Story 1.2** established:
- Role-based redirect system
- Enhanced `lib/roles.ts` with role validation
- Middleware for role-based access control
- Dashboard layouts for each role type

### User Management Architecture
- **Admin Controls**: System-wide operational control through admin tools [Source: prd/07-7-epics-stories.md]
- **Role Assignment**: Admin can assign or change user roles [Source: prd/07-7-epics-stories.md]
- **Access Control**: Role-based access with middleware protection [Source: architecture/03-authorization-flow.md]
- **Session Management**: JWT via cookies with role information [Source: architecture/02-backend-logic.md]

### Database Schema Requirements
- **User Model**: Existing model with role field (Student, Lecturer, Administrator) [Source: architecture/04-database.md]
- **Audit Logging**: New table/schema for tracking role changes
- **ORM**: Prisma for user queries and role updates [Source: architecture/04-database.md]
- **Database**: NeonDB PostgreSQL for persistent storage [Source: architecture/04-database.md]

### API Implementation Requirements
- **Server Actions**: Next.js Server Actions for user management operations [Source: architecture/02-backend-logic.md]
- **Validation**: Zod for role assignment validation [Source: architecture/02-backend-logic.md]
- **Authorization**: Admin-only endpoints with role verification

### Frontend Requirements
- **Framework**: Next.js App Router with admin dashboard integration [Source: architecture/01-frontend.md]
- **UI Components**: shadcn/ui components for user management interface [Source: architecture/01-frontend.md]
- **Styling**: TailwindCSS for responsive user management pages [Source: architecture/01-frontend.md]
- **Admin Dashboard**: Integration with existing `/dashboard/admin` layout

### File Locations (Building on Stories 1.1 & 1.2)
- User management API: `src/app/dashboard/admin/users/actions.ts`
- User management pages: `src/app/dashboard/admin/users/page.tsx`
- User management components: `src/components/admin/UserManagement.tsx`
- Role utilities: `src/lib/roles.ts` (extend with admin functions)
- Audit logging: `src/lib/audit.ts` (new)
- Database schema: Update Prisma schema for audit table

### Technical Implementation Details
- **User Listing**: Query all users with current roles and metadata
- **Role Updates**: Atomic database operations for role changes
- **Session Invalidation**: Force token refresh when roles change
- **Audit Trail**: Comprehensive logging of all role modifications
- **Real-time Updates**: Immediate permission enforcement after changes
- **Admin Verification**: Middleware checks for admin role on all endpoints

### Security Considerations
- **Admin-Only Access**: Strict role verification for user management features
- **Audit Logging**: Complete trail of who changed what and when
- **Session Security**: Proper token invalidation and refresh on role changes
- **Input Validation**: Validate all role assignment requests
- **Authorization Checks**: Verify admin permissions on every operation

### Data Models Required
```typescript
// Extend existing User model
User {
  id, email, role, createdAt, updatedAt
}

// New Audit Log model
RoleChangeLog {
  id, adminUserId, targetUserId, oldRole, newRole, timestamp, reason?
}
```

### UI/UX Requirements
- **User List Table**: Sortable, searchable list with current roles
- **Role Selection**: Clear dropdown with all available roles
- **Confirmation Dialogs**: Confirm before making role changes
- **Success Feedback**: Clear confirmation of successful changes
- **Error Handling**: User-friendly error messages for failures
- **Loading States**: Show progress during role update operations

### Testing Requirements
- **Database Tests**: User queries, role updates, audit logging
- **API Tests**: Admin endpoints, authorization, error handling
- **UI Tests**: User management interface, role selection, confirmations
- **Security Tests**: Access control, admin-only restrictions
- **Integration Tests**: End-to-end role assignment workflow

### Project Structure Notes
Building on Epic 1 foundation:
- Admin dashboard layout exists from Story 1.1
- Role utilities and middleware established in Stories 1.1 & 1.2
- User model exists with role support
- Need to add audit logging capability
- Need to add user management UI to admin dashboard

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-23 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References  
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent QA review of the completed story implementation*
