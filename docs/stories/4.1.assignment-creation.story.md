# Story 4.1: Assignment Creation and Management

## Status
Draft

## Story
**As a** lecturer,
**I want to** create and manage assignments for my courses,
**so that** I can assess student learning and provide structured learning activities

## Acceptance Criteria
1. Lecturers can create assignments with title, description, and requirements
2. Assignment types support multiple formats (essay, quiz, project, file upload)
3. Due dates and submission deadlines are configurable
4. Grading rubrics and point values can be defined
5. Assignment visibility and availability windows are controllable

## Tasks / Subtasks
- [ ] Build assignment creation interface (AC: 1)
  - [ ] Create assignment form with rich text editor for descriptions
  - [ ] Add assignment metadata fields (title, course, category)
  - [ ] Implement assignment requirements and instructions section
  - [ ] Add assignment preview functionality before publishing
  - [ ] Create assignment draft and publish workflow
- [ ] Implement assignment type configuration (AC: 2)
  - [ ] Build file upload assignment type with file restrictions
  - [ ] Create text/essay assignment type with word count limits
  - [ ] Add quiz/multiple choice assignment builder (basic)
  - [ ] Implement project assignment with milestone tracking
  - [ ] Create group assignment configuration options
- [ ] Add deadline and scheduling system (AC: 3)
  - [ ] Implement due date picker with timezone support
  - [ ] Add late submission policy configuration
  - [ ] Create assignment availability window settings
  - [ ] Build automatic deadline reminder system
  - [ ] Add calendar integration for assignment deadlines
- [ ] Build grading configuration system (AC: 4)
  - [ ] Create point-based grading system with total points
  - [ ] Add percentage-based grading with custom scale
  - [ ] Implement rubric builder with criteria and performance levels
  - [ ] Create auto-grading setup for quiz-type assignments
  - [ ] Add grade weight configuration for course integration
- [ ] Implement assignment visibility controls (AC: 5)
  - [ ] Add assignment publication status (draft/published/archived)
  - [ ] Create student group assignment restrictions
  - [ ] Build assignment prerequisite system (optional)
  - [ ] Add assignment release date scheduling
  - [ ] Implement assignment hiding for specific students
- [ ] Optimize for free tier constraints (AC: 1-5)
  - [ ] Implement efficient assignment storage and retrieval
  - [ ] Cache assignment data to minimize database calls
  - [ ] Optimize file upload handling within storage limits
  - [ ] Create batch operations for assignment management
  - [ ] Add pagination for large assignment lists

## Dev Notes

### Previous Story Context
This story builds on completed foundations:
- **Epic 1 (1.1-1.3)**: Authentication with lecturer role management
- **Epic 2 (2.1-2.3)**: Course management and material upload systems
- **Epic 3 (3.1-3.3)**: Student dashboard with calendar integration
- **Dependencies**: Requires course enrollment data, lecturer permissions, and calendar system

### Technical Stack Context - Free Tier Optimized
[Source: docs/prd/technical-stack.md]
- **Frontend**: Next.js, Tailwind CSS (assignment forms and management)
- **Backend**: Supabase (Free Tier - 500MB database, 2GB bandwidth)
- **Database**: PostgreSQL via Supabase for assignment and submission tracking
- **File Storage**: Supabase Storage (1GB total - optimized allocation)
- **Rich Text**: React-based editor (Tiptap or similar lightweight option)
- **Hosting**: Vercel (Free Tier)

### Data Models Extension
Extended database schema for assignment system:
```sql
-- Assignment table
CREATE TABLE assignments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  course_id UUID REFERENCES courses(id) ON DELETE CASCADE,
  lecturer_id UUID REFERENCES users(id) ON DELETE CASCADE,
  title VARCHAR(200) NOT NULL,
  description TEXT,
  instructions TEXT,
  assignment_type VARCHAR(50) DEFAULT 'file_upload', -- 'file_upload', 'text', 'quiz', 'project', 'group'
  max_points DECIMAL(8,2) DEFAULT 100,
  due_date TIMESTAMP,
  available_from TIMESTAMP DEFAULT NOW(),
  available_until TIMESTAMP,
  late_penalty DECIMAL(5,2) DEFAULT 0, -- Percentage per day
  max_late_days INTEGER DEFAULT 0,
  allow_resubmission BOOLEAN DEFAULT false,
  max_attempts INTEGER DEFAULT 1,
  file_types_allowed TEXT[], -- Array of allowed file extensions
  max_file_size_mb INTEGER DEFAULT 10,
  word_count_min INTEGER,
  word_count_max INTEGER,
  status VARCHAR(20) DEFAULT 'draft', -- 'draft', 'published', 'archived'
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Assignment rubrics
CREATE TABLE assignment_rubrics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  assignment_id UUID REFERENCES assignments(id) ON DELETE CASCADE,
  criterion_name VARCHAR(100) NOT NULL,
  criterion_description TEXT,
  max_points DECIMAL(6,2) NOT NULL,
  performance_levels JSONB, -- Array of performance level descriptions
  weight_percentage DECIMAL(5,2) DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Assignment groups (for group assignments)
CREATE TABLE assignment_groups (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  assignment_id UUID REFERENCES assignments(id) ON DELETE CASCADE,
  group_name VARCHAR(100) NOT NULL,
  max_members INTEGER DEFAULT 4,
  min_members INTEGER DEFAULT 2,
  auto_assign BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Assignment prerequisites
CREATE TABLE assignment_prerequisites (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  assignment_id UUID REFERENCES assignments(id) ON DELETE CASCADE,
  prerequisite_assignment_id UUID REFERENCES assignments(id) ON DELETE CASCADE,
  min_grade_required DECIMAL(5,2),
  created_at TIMESTAMP DEFAULT NOW()
);

-- Assignment reminders
CREATE TABLE assignment_reminders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  assignment_id UUID REFERENCES assignments(id) ON DELETE CASCADE,
  reminder_type VARCHAR(20) NOT NULL, -- 'email', 'in_app', 'both'
  days_before INTEGER NOT NULL,
  message_template TEXT,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### File Locations
Based on Next.js conventions and assignment management:
- Assignment pages: `pages/assignments/` or `app/assignments/`
- Create assignment: `pages/assignments/create.js` or `app/assignments/create/page.js`
- Assignment management: `pages/assignments/manage.js` or `app/assignments/manage/page.js`
- Assignment forms: `components/assignments/AssignmentForm.js`, `components/assignments/RubricBuilder.js`
- Assignment types: `components/assignments/FileUploadConfig.js`, `components/assignments/QuizBuilder.js`
- Assignment display: `components/assignments/AssignmentCard.js`, `components/assignments/AssignmentList.js`
- Assignment utilities: `lib/assignmentValidation.js`, `lib/gradingCalculations.js`
- Assignment hooks: `hooks/useAssignments.js`, `hooks/useAssignmentForm.js`

### Free Tier Assignment Optimization
**Efficient Assignment Management Strategy:**
```javascript
// Optimized assignment handling for free tier
const AssignmentOptimization = {
  // Batch assignment operations to minimize API calls
  batchOperations: {
    create: async (assignments) => {
      // Bulk insert assignments with validation
      return await supabase.from('assignments').insert(assignments);
    },
    
    update: async (updates) => {
      // Batch update multiple assignments
      return await supabase.rpc('bulk_update_assignments', { updates });
    }
  },
  
  // Smart caching for assignment data
  cacheStrategy: {
    assignments: 15,    // Cache assignment list for 15 minutes
    rubrics: 30,        // Cache rubrics for 30 minutes
    deadlines: 5,       // Cache upcoming deadlines for 5 minutes
    drafts: 60          // Cache draft assignments for 1 hour
  },
  
  // File upload optimization
  fileHandling: {
    maxSize: 10,        // 10MB max per assignment file
    compression: true,  // Compress images and documents
    validation: true,   // Client-side validation before upload
    chunked: false      // Simple upload for free tier
  }
};
```

### Assignment Creation Interface
```jsx
// Comprehensive assignment creation system
const AssignmentCreationFlow = () => {
  const [assignmentData, setAssignmentData] = useState({
    title: '',
    description: '',
    type: 'file_upload',
    dueDate: null,
    maxPoints: 100,
    rubric: [],
    fileSettings: {}
  });

  return (
    <AssignmentCreationContainer>
      <AssignmentBasicInfo>
        <TitleInput />
        <DescriptionEditor />
        <CourseSelector />
        <AssignmentTypeSelector />
      </AssignmentBasicInfo>
      
      <AssignmentConfiguration>
        <DeadlineSettings>
          <DueDatePicker />
          <AvailabilityWindow />
          <LatePenaltyConfig />
        </DeadlineSettings>
        
        <GradingConfiguration>
          <PointsSelector />
          <RubricBuilder />
          <GradeWeightSetting />
        </GradingConfiguration>
        
        <SubmissionSettings>
          <FileTypeRestrictions />
          <AttemptLimits />
          <ResubmissionPolicy />
        </SubmissionSettings>
      </AssignmentConfiguration>
      
      <AssignmentPreview>
        <StudentViewPreview />
        <GradingPreview />
        <DeadlinePreview />
      </AssignmentPreview>
      
      <PublishControls>
        <SaveDraftButton />
        <PublishButton />
        <SchedulePublishButton />
      </PublishControls>
    </AssignmentCreationContainer>
  );
};
```

### Assignment Type Configurations
**Multiple Assignment Type Support:**
```javascript
// Assignment type definitions and configurations
const AssignmentTypes = {
  file_upload: {
    name: 'File Upload',
    description: 'Students submit files (documents, images, etc.)',
    config: {
      allowedTypes: ['.pdf', '.doc', '.docx', '.txt', '.jpg', '.png'],
      maxFileSize: 10, // MB
      maxFiles: 5,
      requireFileName: true
    },
    grading: 'manual'
  },
  
  text_essay: {
    name: 'Text/Essay',
    description: 'Students submit text responses directly',
    config: {
      minWords: 100,
      maxWords: 2000,
      allowRichText: true,
      plagiarismCheck: false // Not available in free tier
    },
    grading: 'manual'
  },
  
  quiz_multiple_choice: {
    name: 'Quiz',
    description: 'Multiple choice and short answer questions',
    config: {
      questionTypes: ['multiple_choice', 'true_false', 'short_answer'],
      timeLimit: 60, // minutes
      shuffleQuestions: true,
      showResultsImmediately: false
    },
    grading: 'automatic'
  },
  
  project_milestone: {
    name: 'Project',
    description: 'Multi-stage project with milestones',
    config: {
      milestones: [],
      requireProgressUpdates: true,
      allowGroupWork: true,
      finalSubmissionRequired: true
    },
    grading: 'milestone_based'
  }
};
```

### Grading System Integration
**Comprehensive Grading Configuration:**
```javascript
// Grading system for assignments
const GradingSystem = {
  // Point-based grading
  pointBased: {
    totalPoints: 100,
    passingGrade: 60,
    gradeScale: {
      'A': { min: 90, max: 100 },
      'B': { min: 80, max: 89 },
      'C': { min: 70, max: 79 },
      'D': { min: 60, max: 69 },
      'F': { min: 0, max: 59 }
    }
  },
  
  // Rubric-based grading
  rubricBased: {
    criteria: [
      {
        name: 'Content Quality',
        maxPoints: 40,
        levels: ['Excellent', 'Good', 'Satisfactory', 'Needs Improvement']
      },
      {
        name: 'Organization',
        maxPoints: 30,
        levels: ['Clear Structure', 'Mostly Organized', 'Some Organization', 'Poor Organization']
      },
      {
        name: 'Technical Skills',
        maxPoints: 30,
        levels: ['Advanced', 'Proficient', 'Developing', 'Beginning']
      }
    ]
  },
  
  // Late penalty calculation
  latePenalty: {
    calculatePenalty: (daysLate, penaltyRate, maxDays) => {
      if (daysLate <= 0) return 0;
      if (daysLate > maxDays) return 100; // No credit after max days
      return Math.min(daysLate * penaltyRate, 100);
    }
  }
};
```

### Mobile Assignment Management
**Touch-Friendly Assignment Creation:**
- **Mobile Form Optimization**: Single-column layouts with large touch targets
- **Swipe Navigation**: Swipe between assignment configuration sections
- **Quick Templates**: Pre-configured assignment templates for common types
- **Voice Input**: Support for voice-to-text in assignment descriptions
- **Offline Drafts**: Save assignment drafts locally when offline

### Calendar Integration (Building on Story 3.2)
**Assignment Deadline Integration:**
```javascript
// Integration with existing calendar system from Story 3.2
const AssignmentCalendarIntegration = {
  // Add assignment deadlines to student calendars
  addToCalendar: async (assignment) => {
    const calendarEvent = {
      title: `${assignment.title} - Due`,
      description: assignment.description,
      dueDate: assignment.due_date,
      courseId: assignment.course_id,
      type: 'assignment_deadline',
      reminders: [
        { type: 'email', daysBefore: 3 },
        { type: 'in_app', daysBefore: 1 }
      ]
    };
    
    return await addCalendarEvent(calendarEvent);
  },
  
  // Sync assignment changes with calendar
  syncWithCalendar: async (assignmentId, changes) => {
    if (changes.due_date) {
      await updateCalendarEvent(assignmentId, {
        dueDate: changes.due_date
      });
    }
  }
};
```

### Security and Permissions
**Assignment Access Control:**
```javascript
// Security measures for assignment management
const AssignmentSecurity = {
  // Lecturer permissions
  lecturerPermissions: {
    canCreate: (userId, courseId) => isLecturerOfCourse(userId, courseId),
    canEdit: (userId, assignmentId) => isAssignmentOwner(userId, assignmentId),
    canDelete: (userId, assignmentId) => isAssignmentOwner(userId, assignmentId),
    canGrade: (userId, assignmentId) => canAccessGrading(userId, assignmentId)
  },
  
  // Student permissions
  studentPermissions: {
    canView: (studentId, assignmentId) => isEnrolledInCourse(studentId, assignmentId),
    canSubmit: (studentId, assignmentId) => {
      return isWithinDeadline(assignmentId) && 
             isEnrolledInCourse(studentId, assignmentId) &&
             !hasExceededAttempts(studentId, assignmentId);
    }
  },
  
  // Data validation
  validation: {
    assignmentData: true,
    fileUploads: true,
    gradingRubrics: true,
    deadlineLogic: true
  }
};
```

### Performance Optimizations for Free Tier
- **Assignment Caching**: Cache frequently accessed assignment data
- **Lazy Loading**: Load assignment details on demand
- **Optimized Queries**: Use database indexes for assignment searches
- **File Upload Optimization**: Compress files before storage
- **Batch Operations**: Group multiple assignment operations together

### User Experience Features
- **Assignment Templates**: Pre-built templates for common assignment types
- **Drag-and-Drop**: Intuitive file upload with drag-and-drop interface
- **Auto-Save**: Automatically save assignment drafts as lecturer types
- **Preview Mode**: Preview assignments from student perspective
- **Bulk Operations**: Manage multiple assignments simultaneously
- **Assignment Duplication**: Copy existing assignments with modifications

### Integration with Previous Stories
**Building on Completed Systems:**
- **Authentication (Epic 1)**: Lecturer role verification for assignment creation
- **Course Management (Epic 2)**: Course selection and material integration
- **Student Dashboard (Epic 3.1)**: Assignment display in student dashboard
- **Calendar System (Epic 3.2)**: Automatic deadline calendar integration
- **Progress Tracking (Epic 3.3)**: Assignment completion progress updates

### Preparation for Future Stories
**Ready for Assignment Submission (Story 4.2):**
```javascript
// Assignment structure prepared for submission system
const AssignmentSubmissionInterface = {
  submissionSettings: {
    allowedAttempts: assignment.max_attempts,
    resubmissionPolicy: assignment.allow_resubmission,
    lateSubmissionPenalty: assignment.late_penalty,
    fileRequirements: assignment.file_types_allowed
  },
  
  gradingInterface: {
    rubricCriteria: assignment.rubric_criteria,
    maxPoints: assignment.max_points,
    autoGradingEnabled: assignment.assignment_type === 'quiz'
  }
};
```

### Testing Requirements
Assignment creation requires comprehensive testing:
- **Form Validation**: Assignment creation form validation and error handling
- **File Upload**: File type restrictions and size limit enforcement
- **Permission Tests**: Lecturer access control and course ownership
- **Calendar Integration**: Deadline synchronization with calendar system
- **Mobile Responsiveness**: Assignment creation on mobile devices

## Testing

### Testing Standards
Assignment creation and management testing strategy:
- **Unit Tests**:
  - Assignment form validation (`components/assignments/AssignmentForm.test.js`)
  - Grading calculation functions (`lib/gradingCalculations.test.js`)
  - Assignment type configuration logic (`lib/assignmentTypes.test.js`)
- **Component Tests**:
  - Assignment creation wizard flow
  - Rubric builder component functionality
  - File upload configuration interface
  - Assignment preview and validation
- **Integration Tests**:
  - Assignment creation with course integration (`api/assignments.test.js`)
  - Calendar system integration for deadlines
  - Permission-based assignment access control
- **E2E Tests**:
  - Complete assignment creation workflow
  - Assignment publishing and student visibility
  - Cross-browser assignment form functionality
- **Performance Tests**:
  - Assignment list loading with large datasets
  - File upload performance and validation
  - Mobile assignment creation performance

Test file locations:
- `__tests__/assignments/assignmentCreation.test.js`
- `__tests__/api/assignmentApi.test.js`
- `__tests__/e2e/assignmentManagement.test.js`
- `__tests__/components/assignmentComponents.test.js`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-07-21 | 1.0 | Initial assignment creation story with comprehensive type support | Scrum Master (Bob) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here after implementation*
