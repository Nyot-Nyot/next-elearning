# Story 1.2: Role-Based User Redirection After Login

## Status
Draft

## Story
**As a** user,  
**I want** to be redirected based on my role after login,  
**so that** I land directly on my appropriate dashboard without manual navigation

## Acceptance Criteria
1. Student users are redirected to `/dashboard/student` after successful login
2. Lecturer users are redirected to `/dashboard/lecturer` after successful login
3. Admin users are redirected to `/dashboard/admin` after successful login
4. Users with invalid or missing roles receive an appropriate error message
5. Redirect logic works consistently across different login entry points
6. Users cannot access dashboards for other roles (proper access control)

## Tasks / Subtasks

- [ ] Task 1: Enhance role detection and mapping (AC: 1, 2, 3, 4)
  - [ ] Extend `lib/roles.ts` with role constants and validation
  - [ ] Add role-to-dashboard path mapping function
  - [ ] Implement role validation with error handling
  - [ ] Add TypeScript types for user roles

- [ ] Task 2: Update authentication flow for role-based redirects (AC: 1, 2, 3, 5)
  - [ ] Modify login Server Action to include role-based redirect logic
  - [ ] Update BetterAuth callback to handle post-login redirects
  - [ ] Ensure redirect works from login form and direct auth calls
  - [ ] Add redirect parameter handling for deep linking

- [ ] Task 3: Implement middleware-based access control (AC: 6)
  - [ ] Update Next.js middleware to check role permissions
  - [ ] Add route protection based on user role
  - [ ] Implement unauthorized access handling and redirects
  - [ ] Test middleware with different role combinations

- [ ] Task 4: Create role-specific dashboard entry points (AC: 1, 2, 3)
  - [ ] Ensure `/dashboard/student` layout exists and is accessible
  - [ ] Ensure `/dashboard/lecturer` layout exists and is accessible
  - [ ] Ensure `/dashboard/admin` layout exists and is accessible
  - [ ] Add basic content to differentiate each dashboard

- [ ] Task 5: Add error handling and user feedback (AC: 4)
  - [ ] Create error page for invalid role scenarios
  - [ ] Add user-friendly error messages for authorization failures
  - [ ] Implement fallback redirects for edge cases
  - [ ] Add loading states during role resolution

- [ ] Task 6: Test redirect flows comprehensively (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Test login → redirect for each role type
  - [ ] Test unauthorized access attempts to other role dashboards
  - [ ] Test edge cases (missing role, invalid role, role changes)
  - [ ] Verify redirect consistency across different browsers

## Dev Notes

### Previous Story Insights
Story 1.1 established:
- BetterAuth authentication system with JWT sessions
- Basic `lib/roles.ts` structure for role mapping
- Initial dashboard layout structure at `/dashboard/[role]/`
- Next.js middleware foundation for protected routes

### Role-Based Redirect Architecture
- **Redirect Flow**: Role-based redirects after login [Source: architecture/03-authorization-flow.md]
- **Role Mapping**: Implement in `lib/roles.ts` for role mapping and auth guards [Source: architecture/03-authorization-flow.md]
- **Middleware**: Required for protected routes [Source: architecture/03-authorization-flow.md]
- **Session Management**: JWT via cookies with middleware protection per role [Source: architecture/02-backend-logic.md]

### Frontend Routing Requirements
- **Framework**: Next.js App Router [Source: architecture/01-frontend.md]
- **Routing Pattern**: Nested layouts based on user role (`/dashboard/student`, `/dashboard/lecturer`, etc.) [Source: architecture/01-frontend.md]
- **UI Components**: Component-based with responsive layout [Source: architecture/01-frontend.md]

### Database Schema Context
- **User Model**: Must include role field supporting Student, Lecturer, Administrator [Source: prd/07-7-epics-stories.md]
- **ORM**: Prisma for user role queries [Source: architecture/04-database.md]
- **Database**: NeonDB PostgreSQL for role persistence [Source: architecture/04-database.md]

### API Implementation Requirements
- **Server Actions**: Next.js Server Actions for login and redirect logic [Source: architecture/02-backend-logic.md]
- **Validation**: Zod for role validation and input checking [Source: architecture/02-backend-logic.md]

### File Locations (Building on Story 1.1)
- Role utilities: `src/lib/roles.ts` (extend existing)
- Auth configuration: `src/lib/auth.ts` (modify for redirects)
- Middleware: `src/middleware.ts` (enhance with role checking)
- Dashboard layouts: `src/app/dashboard/[role]/` (ensure all exist)
- Error pages: `src/app/error/` or `src/components/auth/RoleError.tsx`

### Technical Implementation Details
- **Role Constants**: Define STUDENT, LECTURER, ADMIN constants
- **Redirect Mapping**: Role → dashboard path mapping function
- **Middleware Logic**: Route pattern matching with role verification
- **Error Handling**: Graceful fallbacks for role resolution failures
- **TypeScript**: Strong typing for role enums and redirect functions

### Security Considerations
- **Access Control**: Users cannot access other role dashboards
- **Session Validation**: Role must be verified with each request
- **Error Information**: Don't expose sensitive role information in errors
- **Redirect Safety**: Prevent open redirect vulnerabilities

### Testing Requirements
- **Unit Tests**: Role mapping and validation functions
- **Integration Tests**: Login → redirect flow for each role
- **Access Control Tests**: Unauthorized access attempts
- **Edge Case Tests**: Missing roles, invalid roles, role changes

### Project Structure Notes
Building on Story 1.1's foundation:
- Dashboard layouts should exist from previous story
- Middleware file should exist but needs role-checking enhancement
- Role utilities need expansion for redirect logic
- Error handling components may need creation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-22 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References  
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent QA review of the completed story implementation*
