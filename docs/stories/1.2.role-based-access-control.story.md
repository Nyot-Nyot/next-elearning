# Story 1.2: Role-Based Access Control

## Status
Draft

## Story
**As a** system administrator,
**I want** users to be assigned specific roles (student, lecturer, admin),
**so that** they only access features appropriate to their role

## Acceptance Criteria
1. Users are assigned one of three roles: student, lecturer, admin
2. Role-based middleware protects routes
3. Users are redirected to appropriate dashboards after login
4. Unauthorized access attempts are blocked and logged

## Tasks / Subtasks
- [ ] Implement role assignment system (AC: 1)
  - [ ] Add role field to user registration process
  - [ ] Create role selection interface for admin users
  - [ ] Implement role validation and assignment logic
  - [ ] Ensure default role assignment for new users
- [ ] Create role-based route protection middleware (AC: 2)
  - [ ] Build Next.js middleware for route protection
  - [ ] Define protected routes configuration
  - [ ] Implement role checking logic in middleware
  - [ ] Add route-level role requirements
- [ ] Implement dashboard redirection logic (AC: 3)
  - [ ] Create role-specific dashboard routes
  - [ ] Implement post-login redirection based on user role
  - [ ] Handle edge cases for users with multiple roles
  - [ ] Create fallback dashboard for undefined roles
- [ ] Add access control logging and monitoring (AC: 4)
  - [ ] Log unauthorized access attempts
  - [ ] Implement security event tracking
  - [ ] Add user activity monitoring
  - [ ] Create admin interface for security logs
- [ ] Create role management utilities (AC: 1, 2)
  - [ ] Build role checking helper functions
  - [ ] Create role constants and enums
  - [ ] Implement role-based UI component rendering
  - [ ] Add role validation utilities
- [ ] Build role-specific navigation and UI (AC: 3)
  - [ ] Create navigation components per role
  - [ ] Implement role-based menu visibility
  - [ ] Design distinct dashboard layouts for each role
  - [ ] Add role indicators in UI

## Dev Notes

### Previous Story Context
This story builds on Story 1.1 (Basic Authentication Setup) which established:
- User authentication with JWT tokens
- Basic session management
- User registration and login functionality
- Authentication context and state management

### Technical Stack Context
[Source: docs/prd/technical-stack.md]
- **Frontend**: Next.js, Tailwind CSS
- **Backend**: Supabase (Free Tier - chosen for completely free implementation)
- **Database**: PostgreSQL via Supabase (Free Tier: 500MB storage)
- **Hosting**: Vercel (Free Tier)

### Authentication Architecture
[Source: docs/architecture/core-components.md#Authentication]
- Role-based redirection after login (student, lecturer, admin)
- JWT-based session management with role information
- Next.js middleware for route protection

### Data Models
[Source: docs/architecture/entity-relationship-overview-for-supabase.md]
- **Users** table structure: (id, name, role, email, avatar)
- Role field supports exactly three values: student, lecturer, admin
- Role is required field for all users

### Data Flow
[Source: docs/architecture/data-flow.md]
- User logs in ‚Üí JWT issued ‚Üí Role-based route loads (Next.js middleware)
- Middleware checks user role against route requirements
- Unauthorized access redirects to appropriate error page

### File Locations
Based on Next.js conventions and extending from Story 1.1:
- Role middleware: `middleware.js` (Next.js root level)
- Role utilities: `lib/roles.js`
- Role constants: `constants/roles.js`
- Dashboard pages: `pages/dashboard/student.js`, `pages/dashboard/lecturer.js`, `pages/dashboard/admin.js`
- Role-based components: `components/roles/`
- Access control hooks: `hooks/useRoleAccess.js`

### Technical Requirements
- Role assignment: Must support exactly three roles (student, lecturer, admin)
- Middleware performance: Route protection should not add significant latency
- Security logging: All unauthorized access attempts must be logged with user ID, timestamp, attempted route
- Dashboard routing: Each role gets distinct dashboard URL and layout
- JWT integration: Role information must be included in JWT payload
- Error handling: Graceful handling of role conflicts and edge cases

### Role-Based Route Configuration
```javascript
// Example route protection configuration
const ROUTE_PERMISSIONS = {
  '/dashboard/student': ['student'],
  '/dashboard/lecturer': ['lecturer'],
  '/dashboard/admin': ['admin'],
  '/courses/create': ['lecturer', 'admin'],
  '/users/manage': ['admin'],
  '/assignments/grade': ['lecturer']
};
```

### Security Considerations
- Role tampering: Client-side role checks must be backed by server-side validation
- Session hijacking: Role changes require re-authentication
- Privilege escalation: No mechanism for users to self-assign roles
- Audit trail: All role-based access decisions must be logged

### Testing
Testing Standards for Role-Based Access:
- Unit tests for role checking utilities
- Integration tests for middleware protection
- E2E tests for complete login-to-dashboard flows
- Security tests for unauthorized access attempts
- Role switching scenarios (admin features)

## Testing

### Testing Standards
Role-based access control requires comprehensive testing:
- **Unit Tests**: Role utility functions, permission checking logic
- **Integration Tests**: Middleware protection, route access validation
- **E2E Tests**: Complete user flows from login to role-specific dashboards
- **Security Tests**: Unauthorized access attempts, role tampering attempts
- **Performance Tests**: Middleware impact on route loading times

Test file locations:
- `__tests__/roles/roleUtils.test.js`
- `__tests__/middleware/authMiddleware.test.js`
- `__tests__/e2e/roleBasedAccess.test.js`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-07-21 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

### üß™ Senior QA Review - Story 1.2: Role-Based Access Control
**Reviewed by:** Quinn (Senior Developer & QA Architect)  
**Review Date:** July 21, 2025  
**Review Type:** Authorization Security & Architecture Assessment

#### üìã **Overall Assessment: MODERATE QUALITY WITH CRITICAL GAPS** ‚≠ê‚≠ê‚≠ê‚ö†Ô∏è‚ö†Ô∏è
This story has a solid foundation but requires significant security hardening and architectural improvements. Critical authorization vulnerabilities must be addressed before implementation.

---

#### ‚ö†Ô∏è **CRITICAL SECURITY VULNERABILITIES**

**1. Insufficient Authorization Model**
```javascript
// CURRENT: Oversimplified role model
roles: ['student', 'lecturer', 'admin']

// REQUIRED: Enterprise authorization model
const authorizationModel = {
  roles: {
    student: {
      permissions: ['read_own_data', 'submit_assignments', 'view_courses'],
      inherits: []
    },
    lecturer: {
      permissions: [
        'read_course_data', 'create_assignments', 'grade_submissions',
        'manage_course_content', 'view_student_progress'
      ],
      inherits: ['student']
    },
    admin: {
      permissions: [
        'manage_users', 'create_courses', 'system_configuration',
        'view_all_data', 'audit_logs'
      ],
      inherits: ['lecturer', 'student']
    }
  },
  permissions: {
    granular: true, // Fine-grained permissions
    contextual: true, // Course/resource-specific permissions
    temporal: true // Time-based permissions (e.g., semester-based)
  }
};
```

**2. Missing Resource-Level Authorization**
```javascript
// CRITICAL GAP: No resource-level access control
// REQUIRED: Resource-based authorization
const resourceAuthorization = {
  courses: {
    read: ['student:enrolled', 'lecturer:assigned', 'admin:all'],
    write: ['lecturer:owner', 'admin:all'],
    delete: ['admin:all']
  },
  assignments: {
    read: ['student:enrolled', 'lecturer:course_owner', 'admin:all'],
    submit: ['student:enrolled'],
    grade: ['lecturer:course_owner', 'admin:all']
  },
  submissions: {
    read: ['student:own', 'lecturer:course_submissions', 'admin:all'],
    modify: ['student:own_before_deadline', 'lecturer:grading', 'admin:all']
  },
  users: {
    read: ['user:own_profile', 'lecturer:enrolled_students', 'admin:all'],
    modify: ['user:own_profile', 'admin:all'],
    delete: ['admin:all']
  }
};
```

**3. Vulnerable Client-Side Security**
```javascript
// SECURITY FLAW: Client-side role checks are insufficient
// REQUIRED: Defense in depth authorization
const securityLayers = {
  frontend: {
    uiRendering: 'Hide unauthorized UI elements',
    routeGuards: 'Prevent navigation to unauthorized routes',
    componentSecurity: 'Role-based component rendering',
    validation: 'Client-side validation for UX only'
  },
  middleware: {
    routeProtection: 'Server-side route authorization',
    apiSecurity: 'API endpoint protection',
    tokenValidation: 'JWT signature and expiry validation',
    roleVerification: 'Database role verification on each request'
  },
  database: {
    rowLevelSecurity: 'PostgreSQL RLS policies',
    accessControl: 'Database-level permission enforcement',
    auditLogging: 'All authorization decisions logged'
  }
};
```

---

#### üîí **Enhanced Security Architecture Required**

**1. Comprehensive Database Security Model**
```sql
-- REQUIRED: Enhanced authorization schema
CREATE TABLE roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(50) UNIQUE NOT NULL,
  description TEXT,
  is_system_role BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE permissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) UNIQUE NOT NULL,
  resource VARCHAR(50) NOT NULL, -- courses, assignments, users, etc.
  action VARCHAR(50) NOT NULL, -- create, read, update, delete
  description TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE role_permissions (
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  permission_id UUID REFERENCES permissions(id) ON DELETE CASCADE,
  granted_at TIMESTAMP DEFAULT NOW(),
  granted_by UUID REFERENCES users(id),
  PRIMARY KEY (role_id, permission_id)
);

CREATE TABLE user_roles (
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  context_type VARCHAR(50), -- 'global', 'course', 'assignment'
  context_id UUID, -- ID of course/assignment if contextual
  assigned_at TIMESTAMP DEFAULT NOW(),
  assigned_by UUID REFERENCES users(id),
  expires_at TIMESTAMP, -- For temporary role assignments
  is_active BOOLEAN DEFAULT true,
  PRIMARY KEY (user_id, role_id, context_type, context_id)
);

-- CRITICAL: Row Level Security policies
ALTER TABLE courses ENABLE ROW LEVEL SECURITY;
ALTER TABLE assignments ENABLE ROW LEVEL SECURITY;
ALTER TABLE submissions ENABLE ROW LEVEL SECURITY;

-- Example RLS policy for courses
CREATE POLICY course_access_policy ON courses
  FOR ALL TO authenticated
  USING (
    -- Admin can access all
    EXISTS (SELECT 1 FROM user_roles ur JOIN roles r ON ur.role_id = r.id 
            WHERE ur.user_id = auth.uid() AND r.name = 'admin')
    OR
    -- Lecturer can access assigned courses
    EXISTS (SELECT 1 FROM user_roles ur JOIN roles r ON ur.role_id = r.id 
            WHERE ur.user_id = auth.uid() AND r.name = 'lecturer' 
            AND ur.context_type = 'course' AND ur.context_id = courses.id)
    OR
    -- Student can access enrolled courses
    EXISTS (SELECT 1 FROM enrollments WHERE student_id = auth.uid() AND course_id = courses.id)
  );
```

**2. Advanced Authorization Middleware**
```javascript
// REQUIRED: Comprehensive authorization middleware
const authorizationMiddleware = {
  routeProtection: {
    validateJWT: async (request) => {
      // Verify JWT signature and expiry
      // Check token blacklist
      // Validate issuer and audience
      return { valid: boolean, payload: object, errors: array };
    },
    
    checkPermissions: async (userId, resource, action, context) => {
      // Query user roles and permissions
      // Check resource-level permissions
      // Validate contextual permissions (course-specific, etc.)
      // Apply time-based restrictions
      return { authorized: boolean, reason: string };
    },
    
    auditAuthorization: async (userId, resource, action, result) => {
      // Log all authorization decisions
      // Track permission usage patterns
      // Flag suspicious access patterns
    }
  },
  
  performanceOptimization: {
    permissionCaching: {
      userPermissions: '5 minutes TTL',
      roleDefinitions: '1 hour TTL',
      invalidateOnRoleChange: true
    },
    batchPermissionChecks: true,
    efficientQueries: 'Optimized JOIN queries for permissions'
  }
};
```

**3. Contextual Authorization System**
```javascript
// REQUIRED: Context-aware authorization
const contextualAuthorization = {
  courseLevel: {
    lecturer_assignment: 'Lecturer assigned to specific course',
    student_enrollment: 'Student enrolled in specific course',
    admin_override: 'Admin access to all courses'
  },
  
  assignmentLevel: {
    submission_window: 'Students can only submit during allowed timeframe',
    grading_access: 'Only course lecturer can grade assignments',
    visibility_control: 'Published vs draft assignment access'
  },
  
  temporalConstraints: {
    semester_based: 'Access expires with course semester',
    assignment_deadlines: 'Submission restrictions after deadline',
    role_expiration: 'Temporary role assignments with expiry'
  },
  
  hierarchicalRoles: {
    department_admin: 'Admin access within specific department',
    course_coordinator: 'Enhanced lecturer permissions for course series',
    teaching_assistant: 'Limited lecturer permissions'
  }
};
```

---

#### üîç **Implementation Issues Identified**

**1. Missing Error Handling Strategy**
```javascript
// CURRENT: Basic unauthorized access blocking
// REQUIRED: Comprehensive error handling
const authorizationErrorHandling = {
  unauthorizedAccess: {
    response: 'HTTP 403 Forbidden with generic message',
    logging: 'Detailed server-side logging with context',
    userFeedback: 'User-friendly error without system details',
    escalation: 'Alert on repeated unauthorized attempts'
  },
  
  roleConflicts: {
    multipleRoles: 'Handle users with multiple overlapping roles',
    roleChanges: 'Graceful handling of role updates during session',
    temporaryRoles: 'Manage expiring role assignments'
  },
  
  systemFailures: {
    authServiceDown: 'Graceful degradation with cached permissions',
    databaseErrors: 'Fallback authorization mechanisms',
    networkIssues: 'Offline authorization for cached users'
  }
};
```

**2. Performance and Scalability Concerns**
```javascript
// REQUIRED: Performance optimizations
const performanceOptimizations = {
  authorizationCaching: {
    userPermissionCache: {
      ttl: '5 minutes',
      invalidationStrategy: 'On role change',
      distributedCache: 'Redis for multi-instance deployment'
    },
    roleHierarchyCache: {
      ttl: '1 hour',
      precomputation: 'Pre-calculate permission inheritance',
      warmupStrategy: 'Background cache warming'
    }
  },
  
  databaseOptimization: {
    indexing: 'Composite indexes on user_roles table',
    queryOptimization: 'Efficient permission lookup queries',
    connectionPooling: 'Optimized database connections'
  },
  
  middlewarePerformance: {
    routeOptimization: 'Skip auth for public routes',
    batchOperations: 'Batch permission checks where possible',
    asynchronousLogging: 'Non-blocking audit logging'
  }
};
```

---

#### üìä **Quality Metrics Assessment**

| Aspect | Current Score | Required Score | Critical Gaps |
|--------|---------------|----------------|---------------|
| **Authorization Model** | 4/10 | 9/10 | No resource-level or contextual permissions |
| **Security Architecture** | 3/10 | 9/10 | Missing defense-in-depth, RLS policies |
| **Database Design** | 5/10 | 9/10 | No permission granularity, missing audit |
| **Middleware Security** | 4/10 | 9/10 | Basic route protection, no resource checks |
| **Error Handling** | 3/10 | 8/10 | Generic errors, no conflict resolution |
| **Performance Design** | 6/10 | 8/10 | No caching strategy, potential bottlenecks |
| **Testing Strategy** | 5/10 | 9/10 | Missing security and edge case tests |
| **Audit & Compliance** | 2/10 | 9/10 | Minimal logging, no permission tracking |

**Overall Authorization Security Score: 4.0/10** - **CRITICAL SECURITY GAPS**

---

#### üéØ **CRITICAL Action Items - Must Implement**

**BLOCKER ISSUES:**
1. **Implement Resource-Level Authorization** - Move beyond simple role checking
2. **Add Database Row-Level Security** - Enforce permissions at data layer
3. **Create Contextual Permission System** - Course/assignment-specific access
4. **Implement Comprehensive Audit Logging** - Track all authorization decisions
5. **Add Permission Caching Strategy** - Ensure performance at scale

**HIGH PRIORITY:**
1. **Enhanced JWT Security** - Include fine-grained permissions in tokens
2. **Role Hierarchy System** - Support permission inheritance
3. **Temporal Authorization** - Time-based access controls
4. **Security Testing Suite** - Comprehensive authorization testing

**MEDIUM PRIORITY:**
1. **Admin Role Management Interface** - Dynamic role assignment
2. **Permission Analytics** - Track permission usage and violations
3. **Multi-tenant Support** - Institution-level isolation
4. **Integration Testing** - End-to-end authorization workflows

---

#### üõ°Ô∏è **Security Compliance Requirements**

```javascript
// REQUIRED: Authorization compliance framework
const complianceRequirements = {
  accessControl: {
    principle: 'Least privilege - users get minimum required permissions',
    enforcement: 'Multi-layer enforcement (UI, API, Database)',
    verification: 'Continuous permission validation',
    auditability: 'Complete access decision audit trail'
  },
  
  dataProtection: {
    studentData: 'FERPA compliance for educational records',
    personalInfo: 'GDPR compliance for EU users',
    encryption: 'Encrypted permission tokens and session data',
    retention: 'Permission history retention policies'
  },
  
  operationalSecurity: {
    monitoring: 'Real-time authorization anomaly detection',
    alerting: 'Immediate alerts on privilege escalation attempts',
    recovery: 'Incident response for authorization breaches',
    testing: 'Regular penetration testing of authorization controls'
  }
};
```

---

#### üìù **Final Assessment & Recommendations**

**CRITICAL FINDING:** This authorization story has fundamental security architecture flaws that could lead to unauthorized data access, privilege escalation, and compliance violations in an educational environment.

**MAJOR CONCERNS:**
- **Oversimplified Authorization Model** - Current 3-role system insufficient for complex LMS needs
- **Missing Resource-Level Security** - No protection for specific courses/assignments
- **Client-Side Security Reliance** - Vulnerable to tampering and bypass attempts
- **No Audit Trail** - Cannot track or investigate authorization decisions

**RECOMMENDATION:** **COMPREHENSIVE REVISION REQUIRED**

**Implementation Strategy:**
1. **Phase 1 (Foundation):** Implement robust database schema with RLS policies
2. **Phase 2 (Middleware):** Build comprehensive authorization middleware
3. **Phase 3 (Features):** Add contextual permissions and admin interfaces
4. **Phase 4 (Monitoring):** Implement audit logging and security monitoring

**Dependencies:** This story is **BLOCKED** until Story 1.1 (Authentication) security issues are resolved, as authorization depends on secure authentication foundation.

---

**QA Status:** üî¥ **BLOCKED - CRITICAL AUTHORIZATION GAPS**  
**Security Clearance:** ‚ùå **NOT APPROVED** - Major security revision required  
**Next Review:** After comprehensive authorization architecture is implemented
