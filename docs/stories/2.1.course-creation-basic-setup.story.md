# Story 2.1: Course Creation and Basic Setup

## Status
Draft

## Story
**As a** lecturer,
**I want to** create new courses with basic information,
**so that** I can organize my teaching materials and students

## Acceptance Criteria
1. Lecturer can create a new course with title, code, and description
2. Course has a unique identifier/code
3. Course can be set as active/inactive
4. Lecturer can edit course basic information
5. Course appears in lecturer's course list

## Tasks / Subtasks
- [ ] Create course creation interface (AC: 1)
  - [ ] Build course creation form with required fields (title, code, description)
  - [ ] Add form validation for required fields and character limits
  - [ ] Implement rich text editor for course description
  - [ ] Add course creation API integration with Supabase
- [ ] Implement unique course code system (AC: 2)
  - [ ] Create course code validation logic (format: DEPT-NUM format, e.g., CS-101)
  - [ ] Add database constraint for unique course codes
  - [ ] Implement real-time course code availability checking
  - [ ] Handle course code conflict resolution
- [ ] Add course status management (AC: 3)
  - [ ] Implement active/inactive toggle for courses
  - [ ] Add status indicator in course list UI
  - [ ] Ensure inactive courses are hidden from student view
  - [ ] Add bulk status update functionality
- [ ] Create course editing functionality (AC: 4)
  - [ ] Build course edit form with pre-populated data
  - [ ] Implement inline editing for quick updates
  - [ ] Add course deletion with confirmation dialog
  - [ ] Handle edit conflicts and data validation
- [ ] Build lecturer course dashboard (AC: 5)
  - [ ] Create responsive course list view with search/filter
  - [ ] Add course cards with quick stats (enrolled students, assignments)
  - [ ] Implement course sorting (by date, name, status)
  - [ ] Add quick action buttons (edit, view, manage students)
- [ ] Implement course data management (AC: 1, 4)
  - [ ] Create Supabase table schema for courses
  - [ ] Add proper database relationships (lecturer_id foreign key)
  - [ ] Implement course data persistence and retrieval
  - [ ] Add course metadata tracking (created_at, updated_at)

## Dev Notes

### Previous Story Context
This story builds on completed authentication stories:
- **Story 1.1**: User authentication system established
- **Story 1.2**: Role-based access control (lecturer role verification)
- **Story 1.3**: User profile management (lecturer profile data)
- **Dependencies**: Requires lecturer role verification and authenticated user context

### Technical Stack Context - Free Tier Optimized
[Source: docs/prd/technical-stack.md]
- **Frontend**: Next.js, Tailwind CSS
- **Backend**: Supabase (Free Tier - 500MB database, 2GB bandwidth)
- **Database**: PostgreSQL via Supabase (Free Tier: sufficient for thousands of courses)
- **Storage**: Supabase Storage (Free Tier: 1GB - course images/thumbnails)
- **Hosting**: Vercel (Free Tier)

### Data Models
[Source: docs/architecture/entity-relationship-overview-for-supabase.md]
- **Courses** table structure: (id, title, code, lecturer_id)
- **Users** table reference: lecturer_id links to Users.id where role='lecturer'
- Extended course schema needed:
```sql
CREATE TABLE courses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(255) NOT NULL,
  code VARCHAR(20) UNIQUE NOT NULL,
  description TEXT,
  lecturer_id UUID REFERENCES users(id),
  status VARCHAR(20) DEFAULT 'active', -- 'active' or 'inactive'
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### File Locations
Based on Next.js conventions and free tier optimization:
- Course pages: `pages/courses/` or `app/courses/`
- Course creation: `pages/courses/create.js` or `app/courses/create/page.js`
- Course management: `pages/courses/manage.js` or `app/courses/manage/page.js`
- Course components: `components/courses/CourseForm.js`, `components/courses/CourseList.js`
- Course utilities: `lib/courses.js`
- Course validation: `utils/courseValidation.js`
- Course hooks: `hooks/useCourses.js`

### Technical Requirements - Free Tier Considerations
- **Database Efficiency**: Optimize queries to minimize API requests (500K/month limit)
- **Course Code Format**: Standardized format to prevent conflicts (e.g., CS-101, MATH-201)
- **Validation**: Client-side validation to reduce server requests
- **Caching**: Implement course data caching to reduce database hits
- **Pagination**: Implement pagination for course lists to manage large datasets
- **Image Optimization**: Course thumbnails must be optimized for 1GB storage limit

### Course Creation Flow
```javascript
// Free tier optimized course creation flow
1. Lecturer fills course form (client-side validation)
2. Real-time course code availability check (cached results)
3. Form submission with optimistic UI updates
4. Supabase insert with conflict handling
5. Course appears in lecturer dashboard immediately
6. Cache invalidation for course lists
```

### Free Tier Optimization Strategies
- **Minimal Database Calls**: Batch operations where possible
- **Client-Side Validation**: Reduce server round-trips
- **Caching Strategy**: Cache course lists and static data
- **Image Compression**: Optimize any course thumbnails for storage limits
- **Efficient Queries**: Use Supabase's built-in optimizations

### Security Considerations
- **Lecturer-Only Access**: Only users with role='lecturer' can create courses
- **Course Ownership**: Lecturers can only edit their own courses
- **Code Uniqueness**: Prevent duplicate course codes across the system
- **Input Sanitization**: Prevent XSS in course descriptions and titles

### User Experience Features
- **Real-time Feedback**: Course code availability checking
- **Auto-save**: Draft course creation to prevent data loss
- **Quick Actions**: Fast course status changes and basic edits
- **Responsive Design**: Mobile-friendly course management
- **Search & Filter**: Easy course discovery in lecturer dashboard

### Testing
Course management requires comprehensive testing:
- **Unit Tests**: Course validation, code generation, status management
- **Integration Tests**: Supabase course CRUD operations
- **Component Tests**: Course forms, lists, and management UI
- **E2E Tests**: Complete course creation and management workflows
- **Role Tests**: Lecturer-only access verification

## Testing

### Testing Standards
Course creation and management testing strategy:
- **Unit Tests**:
  - Course validation functions (`utils/courseValidation.test.js`)
  - Course code generation and checking (`lib/courses.test.js`)
  - Course status management logic
- **Component Tests**:
  - Course creation form validation and submission
  - Course list rendering and interactions
  - Course edit functionality
- **Integration Tests**:
  - Supabase course CRUD operations (`api/courses.test.js`)
  - Real-time course code availability checking
  - Course status updates and persistence
- **E2E Tests**:
  - Complete lecturer course creation workflow
  - Course editing and management user journey
  - Course list search and filtering
- **Role-Based Tests**:
  - Lecturer-only access to course creation
  - Course ownership verification
  - Unauthorized access prevention

Test file locations:
- `__tests__/courses/courseComponents.test.js`
- `__tests__/api/coursesApi.test.js`
- `__tests__/e2e/courseManagement.test.js`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-07-21 | 1.0 | Initial story creation with free tier optimization | Scrum Master (Bob) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

### 🧪 Senior QA Review - Story 2.1: Course Creation and Basic Setup
**Reviewed by:** Quinn (Senior Developer & QA Architect)  
**Review Date:** July 21, 2025  
**Review Type:** Data Integrity, Security & Scalability Assessment

#### 📋 **Overall Assessment: GOOD FOUNDATION WITH ENHANCEMENT OPPORTUNITIES** ⭐⭐⭐⭐⚠️
This story demonstrates solid thinking about free tier optimization and user experience. Good progress, but needs data integrity improvements and enhanced security controls.

---

#### ✅ **Strengths Identified**

**1. Excellent Free Tier Optimization**
- ✅ **Resource Management**: Well-planned database and bandwidth usage
- ✅ **Caching Strategy**: Smart client-side validation and data caching
- ✅ **Efficient Queries**: Proper consideration of API request limits
- ✅ **Storage Optimization**: Appropriate image compression planning

**2. Solid User Experience Design**
- ✅ **Real-time Features**: Course code availability checking
- ✅ **Responsive Design**: Mobile-friendly approach
- ✅ **Auto-save Functionality**: Prevents data loss
- ✅ **Intuitive Workflow**: Logical course creation flow

**3. Good Database Schema Foundation**
- ✅ **Proper Relationships**: Foreign key to users table
- ✅ **Unique Constraints**: Course code uniqueness
- ✅ **Audit Fields**: Created/updated timestamps
- ✅ **Status Management**: Active/inactive course states

---

#### 🔍 **Areas for Enhancement**

**1. Enhanced Data Integrity & Validation**
```sql
-- RECOMMEND: Comprehensive course schema with constraints
CREATE TABLE courses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(255) NOT NULL CHECK (LENGTH(TRIM(title)) >= 3),
  code VARCHAR(20) UNIQUE NOT NULL CHECK (code ~ '^[A-Z]{2,4}-[0-9]{3,4}[A-Z]?$'),
  description TEXT CHECK (LENGTH(description) <= 5000),
  lecturer_id UUID NOT NULL REFERENCES users(id) ON DELETE RESTRICT,
  department VARCHAR(100),
  credits DECIMAL(3,1) CHECK (credits > 0 AND credits <= 20),
  max_enrollment INTEGER CHECK (max_enrollment > 0 AND max_enrollment <= 1000),
  
  -- Enhanced status management
  status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'active', 'inactive', 'archived')),
  published_at TIMESTAMP,
  archived_at TIMESTAMP,
  
  -- Academic period tracking
  semester VARCHAR(20) CHECK (semester IN ('fall', 'spring', 'summer', 'winter')),
  academic_year INTEGER CHECK (academic_year >= 2020 AND academic_year <= 2050),
  
  -- Course metadata
  course_level VARCHAR(20) CHECK (course_level IN ('undergraduate', 'graduate', 'certificate')),
  prerequisites TEXT[], -- Array of prerequisite course codes
  learning_outcomes TEXT[],
  
  -- Audit and compliance
  created_at TIMESTAMP DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP DEFAULT NOW() NOT NULL,
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),
  
  -- Soft delete for data retention
  deleted_at TIMESTAMP,
  deleted_by UUID REFERENCES users(id),
  
  -- Unique constraint for active courses per semester
  UNIQUE (code, semester, academic_year) WHERE deleted_at IS NULL
);

-- RECOMMEND: Course change audit log
CREATE TABLE course_audit_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  course_id UUID REFERENCES courses(id),
  user_id UUID REFERENCES users(id),
  action VARCHAR(50) NOT NULL, -- created, updated, published, archived, deleted
  changes JSONB, -- What fields changed
  old_values JSONB, -- Previous values
  new_values JSONB, -- New values
  reason TEXT, -- Why the change was made
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

**2. Advanced Validation & Business Logic**
```javascript
// RECOMMEND: Comprehensive course validation
const courseValidation = {
  businessRules: {
    codeFormat: {
      pattern: /^[A-Z]{2,4}-[0-9]{3,4}[A-Z]?$/,
      examples: ['CS-101', 'MATH-2010', 'PHYS-301A'],
      validation: 'Department code (2-4 letters) + hyphen + course number + optional section'
    },
    
    titleValidation: {
      minLength: 3,
      maxLength: 255,
      forbiddenChars: ['<', '>', '&', '"'],
      profanityFilter: true,
      duplicateCheck: 'Within same department and academic year'
    },
    
    academicConstraints: {
      semesterValidation: 'Must be valid academic semester',
      yearValidation: 'Academic year must be current or future',
      enrollmentLimits: 'Based on institutional capacity',
      prerequisiteValidation: 'Prerequisites must be valid course codes'
    }
  },
  
  securityValidation: {
    lecturerAuthorization: async (userId, courseData) => {
      // Verify lecturer role and department permissions
      const user = await getUserWithPermissions(userId);
      if (user.role !== 'lecturer') {
        throw new UnauthorizedError('Only lecturers can create courses');
      }
      
      // Check department authorization if applicable
      if (courseData.department && !user.authorizedDepartments.includes(courseData.department)) {
        throw new UnauthorizedError('Not authorized for this department');
      }
      
      return true;
    },
    
    contentSanitization: {
      title: 'HTML encode and validate',
      description: 'Rich text sanitization with allowed tags only',
      codeNormalization: 'Uppercase and format standardization'
    }
  }
};
```

**3. Enhanced Security & Access Control**
```javascript
// RECOMMEND: Comprehensive course security
const courseSecurity = {
  accessControl: {
    creation: {
      roleRequired: 'lecturer',
      departmentAuth: 'Must be authorized for course department',
      semesterLimits: 'Limit courses per semester per lecturer',
      institutionalApproval: 'Some courses may require admin approval'
    },
    
    modification: {
      ownershipVerification: 'Only course owner can edit',
      statusTransitions: 'Controlled state changes (draft→active→archived)',
      historyPreservation: 'Maintain course change history',
      conflictResolution: 'Handle concurrent edit attempts'
    },
    
    deletion: {
      softDelete: 'Preserve course data for records',
      enrollmentCheck: 'Cannot delete courses with active enrollments',
      gradeRetention: 'Maintain grades even after course deletion',
      adminOverride: 'Admin can force delete if necessary'
    }
  },
  
  dataProtection: {
    sensitiveInformation: 'Protect student enrollment data',
    auditLogging: 'Log all course access and modifications',
    backupStrategy: 'Regular course data backups',
    recoveryProcedures: 'Course data recovery mechanisms'
  }
};
```

**4. Performance & Scalability Optimizations**
```javascript
// RECOMMEND: Advanced performance strategies
const performanceOptimizations = {
  databaseOptimization: {
    indexStrategy: {
      primaryLookups: 'Index on (lecturer_id, status, semester)',
      searchOptimization: 'Full-text search index on title and description',
      codeQueries: 'Unique index on course code for fast availability checks',
      timeQueries: 'Index on (academic_year, semester) for period queries'
    },
    
    queryOptimization: {
      eagerLoading: 'Include lecturer data in course queries',
      pagination: 'Efficient cursor-based pagination',
      filtering: 'Database-level filtering to reduce data transfer',
      aggregation: 'Calculate enrollment counts at database level'
    }
  },
  
  cachingStrategy: {
    courseData: {
      activeCourseLists: '15 minutes TTL',
      courseDetails: '5 minutes TTL',
      lecturerCourses: '10 minutes TTL',
      invalidation: 'Smart cache invalidation on updates'
    },
    
    validationCache: {
      courseCodeAvailability: '30 seconds TTL',
      departmentData: '1 hour TTL',
      academicCalendar: '24 hours TTL'
    }
  },
  
  freeTierOptimization: {
    batchOperations: 'Batch multiple course operations',
    compressionStrategy: 'Compress course descriptions and metadata',
    connectionPooling: 'Efficient database connection management',
    backgroundProcessing: 'Non-critical operations in background'
  }
};
```

---

#### 📊 **Quality Metrics Assessment**

| Aspect | Current Score | Target Score | Enhancement Needed |
|--------|---------------|--------------|-------------------|
| **Data Integrity** | 6/10 | 9/10 | Enhanced constraints and validation |
| **Security Controls** | 5/10 | 9/10 | Access control and audit logging |
| **Free Tier Optimization** | 9/10 | 9/10 | Excellent resource management |
| **User Experience** | 8/10 | 9/10 | Good UX with minor enhancements |
| **Scalability Design** | 7/10 | 8/10 | Good foundation with caching needs |
| **Testing Strategy** | 7/10 | 9/10 | Comprehensive but needs edge cases |
| **Error Handling** | 5/10 | 8/10 | Basic error handling needs improvement |
| **Documentation** | 8/10 | 8/10 | Well-documented with clear structure |

**Overall Quality Score: 6.9/10** - **SOLID FOUNDATION WITH ENHANCEMENT OPPORTUNITIES**

---

#### 🎯 **Implementation Recommendations**

**HIGH PRIORITY ENHANCEMENTS:**
1. **Enhanced Data Validation** - Implement comprehensive business rule validation
2. **Audit Logging System** - Track all course changes for compliance
3. **Advanced Error Handling** - Graceful handling of conflicts and edge cases
4. **Security Hardening** - Department authorization and ownership verification

**MEDIUM PRIORITY:**
1. **Performance Monitoring** - Track database query performance
2. **Bulk Operations** - Support for bulk course management
3. **Integration Hooks** - Prepare for enrollment and assignment systems
4. **Advanced Search** - Full-text search capabilities

**NICE TO HAVE:**
1. **Course Templates** - Reusable course structures
2. **Import/Export** - Course data portability
3. **Analytics Integration** - Course usage metrics
4. **Collaboration Features** - Multi-lecturer courses

---

#### 🔧 **Code Quality Improvements**

**1. Enhanced Error Handling**
```javascript
// RECOMMEND: Comprehensive error handling strategy
const courseErrorHandling = {
  validationErrors: {
    duplicateCode: {
      userMessage: 'Course code already exists. Please choose a different code.',
      suggestion: 'Try adding a section letter (e.g., CS-101A)',
      recovery: 'Show similar available codes'
    },
    
    invalidDepartment: {
      userMessage: 'You are not authorized to create courses for this department.',
      suggestion: 'Contact your department administrator',
      recovery: 'Show authorized departments'
    }
  },
  
  systemErrors: {
    databaseFailure: {
      userMessage: 'Unable to save course. Please try again.',
      recovery: 'Auto-save draft and retry',
      logging: 'Log full error details for debugging'
    },
    
    networkFailure: {
      userMessage: 'Connection issue. Your changes have been saved locally.',
      recovery: 'Offline mode with sync when reconnected',
      persistence: 'Local storage backup'
    }
  }
};
```

**2. Testing Enhancements**
```javascript
// RECOMMEND: Comprehensive testing strategy
const testingEnhancements = {
  unitTests: {
    validation: 'Test all validation rules with edge cases',
    businessLogic: 'Test course code generation and conflict resolution',
    errorHandling: 'Test all error scenarios and recovery',
    utilities: 'Test helper functions and data transformations'
  },
  
  integrationTests: {
    apiEndpoints: 'Test all CRUD operations with various scenarios',
    databaseConstraints: 'Test constraint violations and handling',
    caching: 'Test cache invalidation and consistency',
    concurrency: 'Test concurrent course creation and editing'
  },
  
  e2eTests: {
    completeWorkflows: 'Test entire course creation to publication flow',
    errorScenarios: 'Test user experience during errors',
    performanceTests: 'Test with large numbers of courses',
    crossBrowser: 'Test across different browsers and devices'
  }
};
```

---

#### 🏆 **Commendations**

**Outstanding Technical Decisions:**
- **Free Tier Engineering** - Excellent optimization for resource constraints
- **User Experience Focus** - Real-time feedback and intuitive workflows
- **Database Design** - Solid foundation with proper relationships
- **Caching Strategy** - Smart approach to minimize API calls

**Code Quality Highlights:**
- Clear separation of concerns in file organization
- Comprehensive technical requirements documentation
- Good consideration of scalability from the start
- Practical approach to feature implementation

---

#### 📝 **Final Recommendations**

This story represents **solid engineering work** with good attention to free tier constraints and user experience. The foundation is strong and the approach is pragmatic.

**For Implementation Success:**
1. **Start with Enhanced Validation** - Implement robust business rules first
2. **Add Security Layer** - Implement ownership and authorization checks
3. **Performance Testing** - Validate free tier optimization assumptions
4. **Incremental Enhancement** - Build core features first, enhance iteratively

**Integration Readiness:**
- Well-positioned to integrate with enrollment system (Story 2.3)
- Good foundation for assignment system (Epic 4)
- Proper data structure for progress tracking (Epic 3)

**This story is APPROVED for implementation** with the enhancement recommendations incorporated during development.

---

**QA Approval:** ✅ **APPROVED WITH ENHANCEMENTS**  
**Implementation Priority:** High - Core functionality for course management  
**Next Review:** Post-implementation performance validation and security audit
